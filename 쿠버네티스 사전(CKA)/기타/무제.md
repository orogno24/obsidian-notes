# Istio Circuit Breaker 테스트 시나리오 (namespace: `circuit-test`)

> **목표**
> 
> - 두 개의 echo 서비스(`echo-1`, `echo-2`)를 50:50 로드밸런싱
>     
> - `echo-2` 장애 시 **서킷 브레이커(Outlier Detection)** 로 자동 차단 → 트래픽 100 % `echo-1`
>     
> - 장애 복구 후 자동으로 50:50 로드밸런싱 복구
>     

---

## 0. 사전 준비

```bash
# 네임스페이스 생성 & 사이드카 자동 주입 활성화
kubectl create namespace circuit-test
kubectl label namespace circuit-test istio-injection=enabled
```

## 1. echo 서비스 배포 (정상 상태)

```bash
# echo-1 / echo-2 Deployment + 단일 Service("echo")
kubectl apply -f - <<'EOF'
apiVersion: v1
kind: Service
metadata:
  name: echo
  namespace: circuit-test
spec:
  selector:
    app: echo
  ports:
    - name: http
      port: 80
      targetPort: 5678
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-1
  namespace: circuit-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo
      instance: echo-1
  template:
    metadata:
      labels:
        app: echo
        instance: echo-1
    spec:
      containers:
        - name: server
          image: hashicorp/http-echo
          args: ["-text=echo-1"]
          ports:
            - containerPort: 5678
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-2
  namespace: circuit-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo
      instance: echo-2
  template:
    metadata:
      labels:
        app: echo
        instance: echo-2
    spec:
      containers:
        - name: server
          image: hashicorp/http-echo
          args: ["-text=echo-2"]
          ports:
            - containerPort: 5678
EOF
```

> **확인**
> 
> ```bash
> kubectl get pods -n circuit-test -l app=echo -o wide
> ```

## 2. DestinationRule (서킷 브레이커 포함)

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: echo
  namespace: circuit-test
spec:
  host: echo
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    # --- 서킷 브레이커 (Outlier Detection) 설정 ---
    outlierDetection:
      consecutive5xxErrors: 1      # 5xx 1회 발생 시 ejection
      interval: 5s                 # 체크 주기
      baseEjectionTime: 30s        # 차단 지속 시간
      maxEjectionPercent: 100      # 전체 인스턴스까지 차단 허용
  subsets:
    - name: echo-1
      labels:
        instance: echo-1
    - name: echo-2
      labels:
        instance: echo-2
EOF
```

## 3. VirtualService (50:50 트래픽 분배)

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: echo
  namespace: circuit-test
spec:
  hosts:
    - echo
  http:
    - route:
        - destination:
            host: echo
            subset: echo-1
          weight: 50
        - destination:
            host: echo
            subset: echo-2
          weight: 50
EOF
```

---

## 4. 트래픽 분포 확인 (정상 5:5)

```bash
# 테스트용 curl Pod 생성 (필요 시)
kubectl -n circuit-test run curl --image=curlimages/curl:8.7.1 -it --restart=Never -- sh
# 아래 명령을 반복 실행하여 응답을 확인; "echo-1", "echo-2" 가 50:50 로 표시됨
while true; do curl -s http://echo; sleep 0.5; done
```

---

## 5. 장애 시나리오: `echo-2` 장애 유발

```bash
# echo-2를 0 replica 로 스케일 (서비스 중단)
kubectl -n circuit-test scale deployment echo-2 --replicas=0
```

### 기대 결과

- Envoy/LB는 `echo-2`로 전송된 첫 요청에서 5xx → `consecutive5xxErrors: 1` 트리거
    
- 5초 간격으로 상태 확인 후 `echo-2` 인스턴스 **Ejection** (30초 간 차단)
    
- 실시간 트래픽 확인 시 100 % `echo-1` 으로 전송 (10:0)
    

> **모니터링 Tip**
> 
> ```bash
> # Envoy가 보는 엔드포인트 상태 확인
> istioctl proxy-config endpoints $(kubectl -n circuit-test get pod -l instance=echo-1 -o jsonpath='{.items[0].metadata.name}') -n circuit-test --cluster "outbound|80||echo.circuit-test.svc.cluster.local"
> ```

---

## 6. 장애 복구: `echo-2` 정상화

```bash
# echo-2를 다시 1 replica 로 복구
kubectl -n circuit-test scale deployment echo-2 --replicas=1
```

### 기대 결과

- `baseEjectionTime`(30 s) 경과 후 `echo-2` 가 건강한 것으로 판정
    
- VirtualService 50:50 분배로 자동 복귀
    

> 실시간 확인 방법은 **4단계**와 동일합니다.

---

## 7. 정리(Cleanup)

```bash
kubectl delete namespace circuit-test
```

---

### 참고

- **Istio DestinationRule – Outlier Detection 공식 문서**
    
- 테스트 시 `interval`·`baseEjectionTime` 을 짧게 설정한 이유는 데모 시간을 단축하기 위함입니다. 운영 환경에서는 서비스 특성에 맞게 값을 조정하세요.