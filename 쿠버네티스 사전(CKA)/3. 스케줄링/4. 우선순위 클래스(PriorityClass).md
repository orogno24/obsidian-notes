## 1. 우선순위 클래스 개요

우선순위 클래스(Priority Classes)는 쿠버네티스에서 워크로드에 우선순위를 할당하기 위한 메커니즘입니다. 이를 통해 스케줄러는 중요한 워크로드가 리소스 경쟁 상황에서도 항상 스케줄링될 수 있도록 보장합니다.

### 1.1 우선순위 클래스의 필요성

쿠버네티스 클러스터에서는 다양한 중요도를 가진 워크로드가 실행됩니다:

- **시스템 중요 워크로드**: 쿠버네티스 컨트롤 플레인 컴포넌트
- **핵심 애플리케이션**: 데이터베이스, 비즈니스 핵심 서비스
- **일반 워크로드**: 웹 서버, API 서버
- **백그라운드 작업**: 배치 작업, 데이터 처리 작업

리소스가 제한된 상황에서 중요한 워크로드가 항상 우선적으로 실행되도록 하기 위해 우선순위 클래스가 필요합니다.

### 1.2 우선순위 클래스의 특징

- **비 네임스페이스 리소스**: 클러스터 전체에 적용되는 리소스
- **숫자 기반 우선순위**: 값이 클수록 우선순위가 높음
- **선점(Preemption) 정책**: 높은 우선순위 파드가 낮은 우선순위 파드를 밀어낼 수 있음
- **전역 기본값 설정**: 클러스터 내 모든 파드의 기본 우선순위 정의 가능

## 2. 우선순위 값 범위

쿠버네티스에서 우선순위는 숫자로 표현되며, 값이 클수록 우선순위가 높습니다:

### 2.1 우선순위 범위

- **시스템 중요 컴포넌트**: ~2,000,000,000 (20억)
- **사용자 워크로드**: -2,000,000,000 ~ 1,000,000,000 (-20억 ~ 10억)
- **기본값(우선순위 지정하지 않은 경우)**: 0

### 2.2 내장 우선순위 클래스

쿠버네티스는 기본적으로 두 가지 시스템 우선순위 클래스를 제공합니다:

1. **system-cluster-critical**:
    - 값: 2,000,000,000 (20억)
    - 목적: 클러스터 수준에서 중요한 컴포넌트
    
2. **system-node-critical**:
    - 값: 2,000,001,000 (20억 1백만)
    - 목적: 노드 수준에서 중요한 컴포넌트

```bash
# 기존 우선순위 클래스 조회
kubectl get priorityclass
```

출력 예시:

```
NAME                      VALUE        GLOBAL-DEFAULT   AGE
system-cluster-critical   2000000000   false            45d
system-node-critical      2000001000   false            45d
```

## 3. 우선순위 클래스 생성 및 사용

### 3.1 우선순위 클래스 정의

```yaml
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 1000000
globalDefault: false
description: "이 우선순위 클래스는 중요한 프로덕션 애플리케이션을 위한 것입니다."
preemptionPolicy: PreemptLowerPriority
```

**주요 필드 설명**:
- **name**: 우선순위 클래스의 이름
- **value**: 우선순위 값 (숫자가 클수록 우선순위가 높음)
- **globalDefault**: 이 우선순위 클래스를 기본값으로 사용할지 여부
- **description**: 우선순위 클래스에 대한 설명
- **preemptionPolicy**: 선점 정책 (PreemptLowerPriority 또는 Never)

### 3.2 파드에 우선순위 클래스 할당

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: critical-app
spec:
  priorityClassName: high-priority  # 우선순위 클래스 참조
  containers:
  - name: app
    image: nginx
```

### 3.3 기본 우선순위 설정

특정 우선순위 클래스를 클러스터의 기본값으로 지정하려면:

```yaml
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: default-priority
value: 100
globalDefault: true  # 모든 파드의 기본 우선순위로 설정
description: "기본 우선순위 클래스"
```

> ⚠️ **주의**: `globalDefault: true`가 설정된 우선순위 클래스는 클러스터에 하나만 존재할 수 있습니다.

## 4. 선점(Preemption) 정책

선점 정책은 우선순위 클래스가 낮은 우선순위 파드를 밀어낼 수 있는지 여부를 결정합니다.

### 4.1 선점 정책 옵션

1. **PreemptLowerPriority** (기본값)
    - 리소스가 부족할 경우 낮은 우선순위 파드를 종료하고 자신의 파드를 스케줄링
    - 높은 우선순위 워크로드가 항상 실행되도록 보장
    
2. **Never**
    - 다른 파드를 선점하지 않음
    - 리소스가 부족할 경우 스케줄링 큐에서 대기
    - 여전히 스케줄링 우선순위는 유지됨 (대기 중인 다른 낮은 우선순위 파드보다 먼저 스케줄링됨)

### 4.2 선점 정책 설정

```yaml
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: non-preempting-priority
value: 5000
preemptionPolicy: Never  # 선점하지 않음
description: "이 우선순위 클래스는 다른 파드를 선점하지 않습니다."
```

## 5. 우선순위 스케줄링 시나리오

### 5.1 리소스가 충분한 경우

리소스가 충분한 경우

- **시나리오**: 클러스터에 리소스가 충분한 상태
- **결과**: 우선순위에 관계없이 모든 파드가 스케줄링됨
    1. 우선순위 7의 "critical-app" 파드 스케줄링
    2. 우선순위 5의 "jobs-app" 파드 스케줄링

### 5.2 리소스가 부족한 경우 (선점 발생)

선점 발생

- **시나리오**: 클러스터 리소스가 부족한 상태에서 우선순위 6의 "medium-priority-app" 파드 생성
- **선점 정책**: PreemptLowerPriority (기본값)
- **결과**:
    1. 우선순위 5의 "jobs-app" 파드가 종료됨
    2. 우선순위 6의 "medium-priority-app" 파드가 스케줄링됨

### 5.3 선점 없는 우선순위 (preemptionPolicy: Never)

- **시나리오**: 클러스터 리소스가 부족한 상태에서 preemptionPolicy가 Never인 우선순위 6의 파드 생성
- **결과**:
    1. 기존 파드를 종료하지 않음
    2. 리소스가 가용해질 때까지 스케줄링 큐에서 대기
    3. 대기 중인 다른 낮은 우선순위 파드보다는 먼저 스케줄링됨

## 6. 우선순위 클래스 모범 사례

### 6.1 우선순위 클래스 설계 전략

1. **계층적 구조 사용**:
    - 시스템 중요: 900,000,000 ~ 1,000,000,000
    - 프로덕션 중요: 800,000,000 ~ 899,999,999
    - 일반 프로덕션: 500,000,000 ~ 799,999,999
    - 개발/테스트: 0 ~ 499,999,999
    - 배치/백그라운드 작업: < 0
    
2. **우선순위 클래스 수 제한**:
    - 너무 많은 우선순위 클래스는 관리가 복잡해짐
    - 3-5개의 잘 정의된 우선순위 클래스로 시작
    
3. **명확한 명명 규칙**:
    - `high`, `medium`, `low`와 같은 일반적인 이름 피하기
    - `prod-critical`, `prod-standard`, `batch-jobs`와 같이 목적을 명확히 표현

### 6.2 주의사항

1. **선점의 영향 고려**:
    - 선점은 파드 종료를 야기하므로 스테이트풀 워크로드에 주의
    - 중요한 스테이트풀 워크로드는 적절한 PDB(PodDisruptionBudget)와 함께 사용
    
2. **글로벌 기본값 변경 주의**:
    - 기본값 변경은 클러스터의 모든 파드에 영향
    - 운영 중인 클러스터에서는 신중하게 적용
    
3. **리소스 요청과 균형**:
    - 우선순위만으로는 충분하지 않음
    - 적절한 리소스 요청과 함께 사용할 때 효과적
    
4. **권한 관리**:
    - 우선순위 클래스 생성 권한은 클러스터 관리자로 제한
    - 일반 사용자에게는 기존 우선순위 클래스 사용 권한만 부여

## 7. 요약

- 우선순위 클래스는 워크로드의 중요도를 정의하는 비 네임스페이스 리소스입니다.
- 우선순위 값이 클수록 파드의 우선순위가 높아지며, 스케줄링과 선점에 영향을 미칩니다.
- 선점 정책(preemptionPolicy)은 리소스 경쟁 상황에서 낮은 우선순위 파드를 밀어낼 수 있는지 결정합니다.
- 전역 기본값(globalDefault)을 설정하여 기본 우선순위 클래스를 지정할 수 있습니다.
- 효과적인 우선순위 클래스 설계는 워크로드를 계층적으로 분류하고 명확한 명명 규칙을 사용합니다.
## 💡 팁

- **우선순위 클래스는 클러스터에 몇 개만 만들어두면 됨** (보통 3~5개)
- **각 파드는 필요한 경우에만** `priorityClassName`으로 우선순위를 지정함
- **모든 파드에 우선순위를 설정할 필요는 없음**
- 꼭 필요한 워크로드(예: 중요한 서비스, 긴급 작업)에만 설정하면 됨
- 반대로, **클러스터 전체에 기본 우선순위를 주고 싶다면**  
    `globalDefault: true`인 우선순위 클래스를 하나 만들어서 설정하면 됨
- **우선순위를 지정하지 않으면 기본값 0**으로 동작함
- **중요한 파드에만 우선순위를 명시**하는 게 일반적임
- 클러스터 내에 globalDefault: true는 딱 하나만 존재 가능

