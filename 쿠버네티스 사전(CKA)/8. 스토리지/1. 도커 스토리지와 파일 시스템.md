## Docker가 데이터를 저장하는 방식

### 기본 저장 위치
- Docker는 기본적으로 `/var/lib/docker/` 폴더에 모든 데이터를 저장
- 이 폴더 아래에 여러 하위 폴더가 있음:
    - `containers`: 컨테이너 관련 파일
    - `images`: 이미지 관련 파일
    - `volumes`: 볼륨 데이터
## Docker의 레이어 구조

### 이미지 레이어

- Docker는 **레이어 구조**로 이미지를 만듦
- Dockerfile의 각 명령어가 하나의 레이어 생성
- 예시 레이어 구조:
    1. 기본 Ubuntu OS (예: 120MB)
    2. APT 패키지 설치 (예: 300MB)
    3. Python 패키지 설치
    4. 소스 코드 복사
    5. 엔트리포인트 설정

### 레이어 구조의 장점

1. **디스크 공간 절약**: 각 레이어는 이전 레이어와의 차이점만 저장
2. **빌드 시간 단축**: 변경된 레이어만 다시 빌드
3. **캐시 효율성**: 동일한 레이어는 여러 이미지에서 재사용

### 예시로 이해하기

- 애플리케이션 A와 B가 같은 기본 이미지와 패키지를 사용
- 소스 코드만 다른 경우, Docker는 처음 3개 레이어를 재사용
- 소스 코드 업데이트 시에도 변경된 레이어만 다시 빌드

## 컨테이너와 쓰기 가능 레이어

### 읽기 전용 vs 쓰기 가능 레이어

- 이미지 레이어: **읽기 전용**(Read-Only)
- 컨테이너 레이어: **쓰기 가능**(Read-Write)

### 컨테이너 레이어의 특징

- 컨테이너 실행 시 이미지 위에 쓰기 가능 레이어 추가
- 컨테이너에서 생성/수정된 모든 파일은 이 레이어에 저장
- 컨테이너 삭제 시 이 레이어의 모든 데이터도 함께 삭제됨

### Copy-on-Write 메커니즘

- 이미지 레이어의 파일을 수정하려고 하면:
    1. Docker가 자동으로 해당 파일을 쓰기 가능 레이어로 복사
    2. 사용자는 복사된 버전을 수정하게 됨
    3. 원본 이미지 레이어의 파일은 변경되지 않음

## 데이터 영구 저장하기

### 문제점

- 컨테이너가 삭제되면 컨테이너 레이어의 모든 데이터도 삭제됨
- 데이터베이스 같은 애플리케이션은 데이터 유지가 필요

### 볼륨(Volume)을 사용한 해결책

#### 1. 볼륨 마운트(Volume Mount)

- Docker 호스트 볼륨 사용

```bash
# 볼륨 생성
docker volume create data_volume

# 볼륨을 마운트하여 컨테이너 실행
docker run -v data_volume:/var/lib/mysql mysql
```

- 볼륨은 `/var/lib/docker/volumes/` 아래에 저장됨
- 컨테이너 삭제 후에도 데이터 유지
- Docker가 완전히 관리 (Docker 명령어로 관리)

#### 2. 바인드 마운트(Bind Mount)

- 호스트의 특정 디렉토리를 컨테이너에 연결

```bash
# 호스트 경로를 컨테이너에 마운트
docker run -v /data/mysql:/var/lib/mysql mysql
```

- 호스트의 어느 위치든 마운트 가능
- 바인드 마운트: 사용자가 직접 관리 (OS 파일 시스템 명령어로 관리)

### 최신 마운트 방식: `--mount` 옵션

- 더 명확하고 자세한 설정 가능

```bash
docker run --mount type=bind,source=/data/mysql,target=/var/lib/mysql mysql
```

## 스토리지 드라이버(Storage Driver)

### 역할

- 레이어 구조 관리
- 쓰기 가능 레이어 생성
- Copy-on-Write 기능 처리

### 주요 스토리지 드라이버

- **AUFS**: Ubuntu 기본 드라이버
- **Device Mapper**: CentOS/RHEL 계열 기본
- **Overlay2**: 최신 리눅스 배포판에서 권장
- **BTRFS**, **ZFS**: 특정 파일 시스템에 최적화

### 드라이버 선택

- 운영체제에 따라 자동 선택됨
- 성능과 안정성 요구사항에 따라 수동 선택 가능

## 실무 활용 팁

### 이미지 최적화

- 변경이 적은 레이어를 Dockerfile 앞부분에 배치
- 자주 변경되는 파일은 마지막에 추가

### 볼륨 사용 방식

- 데이터베이스: 명명된 볼륨 사용 권장
- 설정 파일: 바인드 마운트 고려
- 임시 데이터: tmpfs 마운트 활용

### 스토리지 드라이버 고려사항

- 프로덕션 환경: 안정성 우선 (Overlay2 권장)
- 개발 환경: 기본 드라이버로 충분