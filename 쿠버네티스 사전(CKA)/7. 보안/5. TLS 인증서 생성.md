## 1. ì¸ì¦ì„œ ìƒì„± ë„êµ¬ ì†Œê°œ

ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ TLS ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ ë‹¤ì–‘í•œ ë„êµ¬ê°€ ìˆìŠµë‹ˆë‹¤:

- **OpenSSL**: ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ ì•”í˜¸í™” ë„êµ¬
- **Easy-RSA**: PKI(Public Key Infrastructure) ê´€ë¦¬ë¥¼ ë‹¨ìˆœí™”í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ëª¨ìŒ
- **CFSSL**: CloudFlareì˜ PKI/TLS ë„êµ¬
- **ê¸°íƒ€**: keytool, certgen ë“±

> ğŸ’¡ **ì°¸ê³ **: ì´ ê°€ì´ë“œì—ì„œëŠ” OpenSSLì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## 2. CA(ì¸ì¦ ê¸°ê´€) ì¸ì¦ì„œ ìƒì„±

ì¸ì¦ì„œ ìƒì„±ì˜ ì²« ë‹¨ê³„ëŠ” CA(ì¸ì¦ ê¸°ê´€) ì¸ì¦ì„œë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### CA ê°œì¸ í‚¤ ìƒì„±

```bash
openssl genrsa -out ca.key 2048
```

ì´ ëª…ë ¹ì€ 2048ë¹„íŠ¸ ê¸¸ì´ì˜ RSA ê°œì¸ í‚¤ë¥¼ ìƒì„±í•˜ì—¬ `ca.key` íŒŒì¼ì— ì €ì¥í•©ë‹ˆë‹¤.

### CA CSR(ì¸ì¦ì„œ ì„œëª… ìš”ì²­) ìƒì„±

```bash
openssl req -new -key ca.key -subj "/CN=kubernetes-ca" -out ca.csr
```

- **-key**: ì‚¬ìš©í•  ê°œì¸ í‚¤ ì§€ì •
- **-subj**: ì¸ì¦ì„œ ì£¼ì²´(Subject) ì •ë³´ ì§€ì •
- **CN(Common Name)**: kubernetes-caë¡œ ì„¤ì •

### CA ì¸ì¦ì„œ ìƒì„±(ìì²´ ì„œëª…)

```bash
openssl x509 -req -in ca.csr -signkey ca.key -CAcreateserial -out ca.crt -days 1000
```

- **-req**: CSRì„ ì²˜ë¦¬í•¨ì„ ë‚˜íƒ€ëƒ„
- **-signkey**: ìì²´ ì„œëª…ì— ì‚¬ìš©í•  í‚¤ ì§€ì •
- **-days**: ì¸ì¦ì„œ ìœ íš¨ ê¸°ê°„(ì¼)

CA ì¸ì¦ì„œ ìƒì„±ì´ ì™„ë£Œë˜ë©´ `ca.key`(ê°œì¸ í‚¤)ì™€ `ca.crt`(ì¸ì¦ì„œ) íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤. ëª¨ë“  ë‹¤ë¥¸ ì¸ì¦ì„œëŠ” ì´ CAì— ì˜í•´ ì„œëª…ë©ë‹ˆë‹¤.

## 3. í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ ìƒì„±

### 3.1 ê´€ë¦¬ì(Admin) ì¸ì¦ì„œ

#### ê°œì¸ í‚¤ ìƒì„±

```bash
openssl genrsa -out admin.key 2048
```

#### CSR ìƒì„±

```bash
openssl req -new -key admin.key -subj "/CN=kube-admin/O=system:masters" -out admin.csr
```

- **CN**: kube-admin (ê´€ë¦¬ì ì´ë¦„)
- **O(Organization)**: system:masters (ê´€ë¦¬ì ê¶Œí•œ ê·¸ë£¹)

> âš ï¸ **ì¤‘ìš”**: `system:masters`ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§„ íŠ¹ë³„ ê·¸ë£¹ì…ë‹ˆë‹¤. ì´ ê·¸ë£¹ì— ì†í•œ ì‚¬ìš©ìëŠ” í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ì™„ì „í•œ ê¶Œí•œì„ ê°–ìŠµë‹ˆë‹¤.

#### ì¸ì¦ì„œ ì„œëª…

```bash
openssl x509 -req -in admin.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out admin.crt -days 1000
```

### 3.2 kube-scheduler ì¸ì¦ì„œ

#### ê°œì¸ í‚¤ ìƒì„±

```bash
openssl genrsa -out scheduler.key 2048
```

#### CSR ìƒì„±

```bash
openssl req -new -key scheduler.key -subj "/CN=system:kube-scheduler" -out scheduler.csr
```

- **CN**: system:kube-scheduler

> ğŸ“ **ì°¸ê³ **: ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸ì˜ ê²½ìš° ì´ë¦„ ì•ì— `system:`ì„ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤.

#### ì¸ì¦ì„œ ì„œëª…

```bash
openssl x509 -req -in scheduler.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out scheduler.crt -days 1000
```

### 3.3 kube-controller-manager ì¸ì¦ì„œ

#### ê°œì¸ í‚¤ ìƒì„±

```bash
openssl genrsa -out controller-manager.key 2048
```

#### CSR ìƒì„±

```bash
openssl req -new -key controller-manager.key -subj "/CN=system:kube-controller-manager" -out controller-manager.csr
```

#### ì¸ì¦ì„œ ì„œëª…

```bash
openssl x509 -req -in controller-manager.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out controller-manager.crt -days 1000
```

### 3.4 kube-proxy ì¸ì¦ì„œ

#### ê°œì¸ í‚¤ ìƒì„±

```bash
openssl genrsa -out kube-proxy.key 2048
```

#### CSR ìƒì„±

```bash
openssl req -new -key kube-proxy.key -subj "/CN=system:kube-proxy" -out kube-proxy.csr
```

#### ì¸ì¦ì„œ ì„œëª…

```bash
openssl x509 -req -in kube-proxy.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out kube-proxy.crt -days 1000
```

## 4. ì„œë²„ ì¸ì¦ì„œ ìƒì„±

### 4.1 etcd ì„œë²„ ì¸ì¦ì„œ

#### ê°œì¸ í‚¤ ìƒì„±

```bash
openssl genrsa -out etcdserver.key 2048
```

#### CSR ìƒì„±

```bash
openssl req -new -key etcdserver.key -subj "/CN=etcd-server" -out etcdserver.csr
```

#### ì¸ì¦ì„œ ì„œëª…

```bash
openssl x509 -req -in etcdserver.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out etcdserver.crt -days 1000
```

> ğŸ”„ **ì°¸ê³ **: ê³ ê°€ìš©ì„± êµ¬ì„±ì—ì„œëŠ” etcd í”¼ì–´ ê°„ í†µì‹ ì„ ìœ„í•œ ì¶”ê°€ ì¸ì¦ì„œ(peer certificates)ë„ í•„ìš”í•©ë‹ˆë‹¤.

### 4.2 kube-apiserver ì¸ì¦ì„œ

kube-apiserverëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ì—¬ëŸ¬ ì´ë¦„ìœ¼ë¡œ ì°¸ì¡°ë˜ë¯€ë¡œ, ì¸ì¦ì„œì— ëª¨ë“  ëŒ€ì²´ ì´ë¦„(SAN, Subject Alternative Name)ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.

#### ê°œì¸ í‚¤ ìƒì„±

```bash
openssl genrsa -out apiserver.key 2048
```

#### OpenSSL êµ¬ì„± íŒŒì¼ ìƒì„±

`openssl.cnf` íŒŒì¼ì„ ë‹¤ìŒê³¼ ê°™ì´ ìƒì„±í•©ë‹ˆë‹¤:

```
[req]
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names
[alt_names]
DNS.1 = kubernetes
DNS.2 = kubernetes.default
DNS.3 = kubernetes.default.svc
DNS.4 = kubernetes.default.svc.cluster.local
IP.1 = 10.96.0.1
IP.2 = 192.168.5.11
```

> ğŸ’¡ **ì¤‘ìš”**: IP ì£¼ì†ŒëŠ” í™˜ê²½ì— ë§ê²Œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤. IP.1ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤ IP, IP.2ëŠ” kube-apiserverê°€ ì‹¤í–‰ë˜ëŠ” í˜¸ìŠ¤íŠ¸ì˜ IPì…ë‹ˆë‹¤.

#### CSR ìƒì„± (SAN í¬í•¨)

```bash
openssl req -new -key apiserver.key -subj "/CN=kube-apiserver" -config openssl.cnf -out apiserver.csr
```

#### ì¸ì¦ì„œ ì„œëª…

```bash
openssl x509 -req -in apiserver.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out apiserver.crt -extensions v3_req -extfile openssl.cnf -days 1000
```

### 4.3 kubelet ì„œë²„ ì¸ì¦ì„œ

kubeletì€ ê° ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ, ê° ë…¸ë“œë§ˆë‹¤ ê³ ìœ í•œ ì¸ì¦ì„œê°€ í•„ìš”í•©ë‹ˆë‹¤.

#### ë…¸ë“œ1 ì¸ì¦ì„œ (ì˜ˆ: node01)

1. **ê°œì¸ í‚¤ ìƒì„±**
    
    ```bash
    openssl genrsa -out node01.key 2048
    ```
    
2. **CSR ìƒì„±**
    
    ```bash
    openssl req -new -key node01.key -subj "/CN=node01" -out node01.csr
    ```
    
3. **ì¸ì¦ì„œ ì„œëª…**
    
    ```bash
    openssl x509 -req -in node01.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out node01.crt -days 1000
    ```
    

ê° ë…¸ë“œì— ëŒ€í•´ ìœ„ ê³¼ì •ì„ ë°˜ë³µí•©ë‹ˆë‹¤.

## 5. kubelet í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ ìƒì„±

kubeletì€ ì„œë²„ ì—­í• ë¿ë§Œ ì•„ë‹ˆë¼ kube-apiserverì— ëŒ€í•œ í´ë¼ì´ì–¸íŠ¸ ì—­í• ë„ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œë„ í•„ìš”í•©ë‹ˆë‹¤.

### ë…¸ë“œ1 í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ (ì˜ˆ: node01)

1. **ê°œì¸ í‚¤ ìƒì„±**
    
    ```bash
    openssl genrsa -out node01-client.key 2048
    ```
    
2. **CSR ìƒì„±**
    
    ```bash
  openssl req -new -key node01-client.key \
  -subj "/CN=system:node:node01/O=system:nodes" \
  -out node01-client.csr
    ```

|í•„ë“œ|ê°’|ì˜ë¯¸|
|---|---|---|
|CN|`system:node:node01`|`node01`ì´ë¼ëŠ” ë…¸ë“œë¥¼ ì‹ë³„í•˜ëŠ” ì´ë¦„|
|O|`system:nodes`|Kubernetesì˜ **ë…¸ë“œ ê·¸ë£¹**ìœ¼ë¡œ, ë…¸ë“œê°€ `kube-apiserver`ì— ì¸ì¦ë°›ì„ ë•Œ ìš”êµ¬ë¨|
1. **ì¸ì¦ì„œ ì„œëª…**
    
    ```bash
openssl x509 -req -in node01-client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out node01-client.crt -days 1000
    ```
ê° ë…¸ë“œì— ëŒ€í•´ ìœ„ ê³¼ì •ì„ ë°˜ë³µí•©ë‹ˆë‹¤.

## 6. kube-apiserver í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ ìƒì„±

kube-apiserverëŠ” etcdì™€ kubeletì— ì ‘ê·¼í•  ë•Œ í´ë¼ì´ì–¸íŠ¸ ì—­í• ì„ í•©ë‹ˆë‹¤.

### 6.1 etcd í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ

```bash
# ê°œì¸ í‚¤ ìƒì„±
openssl genrsa -out apiserver-etcd-client.key 2048

# CSR ìƒì„±
openssl req -new -key apiserver-etcd-client.key -subj "/CN=apiserver-etcd-client" -out apiserver-etcd-client.csr

# ì¸ì¦ì„œ ì„œëª…
openssl x509 -req -in apiserver-etcd-client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out apiserver-etcd-client.crt -days 1000
```

### 6.2 kubelet í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ

```bash
# ê°œì¸ í‚¤ ìƒì„±
openssl genrsa -out apiserver-kubelet-client.key 2048

# CSR ìƒì„±
openssl req -new -key apiserver-kubelet-client.key -subj "/CN=apiserver-kubelet-client/O=system:masters" -out apiserver-kubelet-client.csr

# ì¸ì¦ì„œ ì„œëª…
openssl x509 -req -in apiserver-kubelet-client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out apiserver-kubelet-client.crt -days 1000
```

## 7. ì¸ì¦ì„œ í™œìš© ë°©ë²•

### 7.1 kubeconfig íŒŒì¼ ìƒì„±

ìƒì„±ëœ ì¸ì¦ì„œëŠ” kubeconfig íŒŒì¼ì— í†µí•©í•˜ì—¬ ì¿ ë²„ë„¤í‹°ìŠ¤ êµ¬ì„± ìš”ì†Œê°€ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```bash
# admin ì‚¬ìš©ìë¥¼ ìœ„í•œ kubeconfig ì˜ˆì‹œ
kubectl config set-cluster kubernetes \
  --certificate-authority=ca.crt \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=admin.kubeconfig

kubectl config set-credentials admin \
  --client-certificate=admin.crt \
  --client-key=admin.key \
  --embed-certs=true \
  --kubeconfig=admin.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes \
  --user=admin \
  --kubeconfig=admin.kubeconfig

kubectl config use-context default --kubeconfig=admin.kubeconfig
```

### 7.2 êµ¬ì„± ìš”ì†Œë³„ ì¸ì¦ì„œ ì„¤ì •

#### kube-apiserver

```
--client-ca-file=ca.crt
--tls-cert-file=apiserver.crt
--tls-private-key-file=apiserver.key
--etcd-cafile=ca.crt
--etcd-certfile=apiserver-etcd-client.crt
--etcd-keyfile=apiserver-etcd-client.key
--kubelet-client-certificate=apiserver-kubelet-client.crt
--kubelet-client-key=apiserver-kubelet-client.key
```

#### etcd

```
--cert-file=etcdserver.crt
--key-file=etcdserver.key
--client-cert-auth
--trusted-ca-file=ca.crt
```

#### kubelet

```
--client-ca-file=ca.crt
--tls-cert-file=node01.crt
--tls-private-key-file=node01.key
```

ì´í›„ kubeconfig íŒŒì¼ì„ í†µí•´ kube-apiserver í†µì‹ ì— í•„ìš”í•œ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ ì„¤ì •.

## 8. ì¸ì¦ì„œ ê´€ë¦¬ ë° ì£¼ì˜ì‚¬í•­

1. **ì•ˆì „í•œ ì €ì¥**: ëª¨ë“  ê°œì¸ í‚¤(.key íŒŒì¼)ëŠ” ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ê³  ì ‘ê·¼ì„ ì œí•œí•´ì•¼ í•©ë‹ˆë‹¤.
2. **ë°±ì—…**: ì¸ì¦ì„œì™€ ê°œì¸ í‚¤ëŠ” ì •ê¸°ì ìœ¼ë¡œ ë°±ì—…í•´ì•¼ í•©ë‹ˆë‹¤.
3. **ê°±ì‹ **: ì¸ì¦ì„œëŠ” ë§Œë£Œ ì „ì— ê°±ì‹ í•´ì•¼ í•©ë‹ˆë‹¤. ë§Œë£Œëœ ì¸ì¦ì„œëŠ” í´ëŸ¬ìŠ¤í„° ì¤‘ë‹¨ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
4. **ìë™í™”**: ëŒ€ê·œëª¨ í´ëŸ¬ìŠ¤í„°ì—ì„œëŠ” certmanagerì™€ ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œ ê´€ë¦¬ë¥¼ ìë™í™”í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
5. **ëª…ëª… ê·œì¹™**: ì¸ì¦ì„œì™€ í‚¤ íŒŒì¼ì— ì¼ê´€ëœ ëª…ëª… ê·œì¹™ì„ ì‚¬ìš©í•˜ì—¬ ê´€ë¦¬ë¥¼ ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤.

## ìš”ì•½

- ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ëŠ” ë‹¤ì–‘í•œ ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ì„± ìš”ì†Œ ê°„ í†µì‹ ì„ ë³´í˜¸í•©ë‹ˆë‹¤.
- ëª¨ë“  ì¸ì¦ì„œëŠ” CA ì¸ì¦ì„œë¡œ ì„œëª…ë˜ì–´ ì‹ ë¢°ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œëŠ” kube-apiserverì— ì ‘ê·¼í•˜ëŠ” êµ¬ì„± ìš”ì†Œ(ê´€ë¦¬ì, ìŠ¤ì¼€ì¤„ëŸ¬, ì»¨íŠ¸ë¡¤ëŸ¬ ë“±)ì— í•„ìš”í•©ë‹ˆë‹¤.
- ì„œë²„ ì¸ì¦ì„œëŠ” API ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” êµ¬ì„± ìš”ì†Œ(kube-apiserver, etcd, kubelet)ì— í•„ìš”í•©ë‹ˆë‹¤.
- ì¼ë¶€ êµ¬ì„± ìš”ì†ŒëŠ” ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ì—­í• ì„ ëª¨ë‘ ìˆ˜í–‰í•˜ë¯€ë¡œ ë‘ ìœ í˜•ì˜ ì¸ì¦ì„œê°€ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤.
- ì¸ì¦ì„œ ì´ë¦„ê³¼ ê·¸ë£¹ ì„¤ì •ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ê¶Œí•œ ê´€ë¦¬ ì‹œìŠ¤í…œê³¼ ë°€ì ‘í•˜ê²Œ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.