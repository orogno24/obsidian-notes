## CNI가 필요한 이유

### 공통적인 네트워킹 문제

- 모든 컨테이너 기술들이 비슷한 네트워킹 문제를 해결해야 함
    - 네트워크 네임스페이스 생성
    - 가상 케이블(veth pair) 생성
    - 브릿지 네트워크 연결
    - IP 주소 할당
    - 외부 통신을 위한 NAT 설정

### 중복 개발 문제

- Docker, Rocket, Kubernetes 등 모든 도구가 비슷한 방식으로 구현
- 각자 다른 코드로 같은 문제를 해결하는 비효율

### 표준화의 필요성

- 모든 컨테이너 기술이 사용할 수 있는 공통 네트워킹 표준 필요
- 한 번 개발하고 여러 환경에서 재사용 가능한 플러그인 시스템 필요

## CNI란?

### CNI의 정의

- **Container Network Interface**: 컨테이너 네트워킹을 위한 표준
- 컨테이너 런타임과 네트워크 플러그인 간의 인터페이스 정의
- 네트워크 플러그인 개발 방법과 호출 방법에 대한 규약

### 표준화된 접근 방식

```
┌─────────────────┐      ┌───────────────┐
│                 │      │               │
│   컨테이너      │      │   네트워크    │
│   런타임        │ ──── │   플러그인    │
│ (Kubernetes 등) │      │ (Bridge 등)   │
│                 │      │               │
└─────────────────┘      └───────────────┘
         │                      │
         └──────────┬───────────┘
                    │
             표준화된 인터페이스
                   CNI
```

## CNI 표준 규약

### 컨테이너 런타임의 책임

1. 각 컨테이너를 위한 네트워크 네임스페이스 생성
2. 컨테이너가 연결될 네트워크 식별
3. 컨테이너 생성 시 `add` 명령으로 플러그인 호출
4. 컨테이너 삭제 시 `del` 명령으로 플러그인 호출
5. JSON 파일을 통한 네트워크 플러그인 구성

### 플러그인의 책임

1. `add`, `del`, `check` 명령어 지원
2. 컨테이너 ID와 네트워크 네임스페이스 매개변수 처리
3. IP 주소 할당
4. 필요한 라우팅 설정
5. 표준 형식으로 결과 반환

### 플러그인 호출 예시

```bash
# 컨테이너 생성 시 플러그인 호출
bridge add <컨테이너ID> <네임스페이스>

# 컨테이너 삭제 시 플러그인 호출
bridge del <컨테이너ID> <네임스페이스>
```

## CNI 플러그인 종류

### 기본 제공 플러그인

- **Bridge**: 표준 리눅스 브릿지 네트워크 구성
- **VLAN**: VLAN 태깅 지원
- **IPVLAN**: IP 계층 가상화
- **MACVLAN**: MAC 계층 가상화
- **Windows**: 윈도우 환경 지원

### IPAM(IP Address Management) 플러그인

- **Host-Local**: 로컬 IP 주소 할당
- **DHCP**: DHCP를 통한 IP 주소 할당

### 서드파티 플러그인

- **Weave**: 멀티호스트 컨테이너 네트워킹
- **Flannel**: 쿠버네티스를 위한 단순한 오버레이 네트워크
- **Calico**: 보안 정책 지원 네트워크
- **Cilium**: eBPF 기반 네트워킹 및 보안
- **VMware NSX**: VMware의 네트워크 가상화 솔루션
- **Infoblox**: 엔터프라이즈 IP 주소 관리

## Docker와 CNI의 관계

### Docker는 CNI를 구현하지 않음

- Docker는 자체적인 CNM(Container Network Model) 표준 사용
- CNI 플러그인은 Docker와 직접 호환되지 않음

### Docker와 CNI 함께 사용하기

- 직접 통합은 불가능하지만 우회 방법 존재
- 방법: Docker 컨테이너를 네트워크 없이 생성 후 수동으로 CNI 플러그인 호출

### Kubernetes의 Docker 컨테이너 네트워킹

1. Kubernetes는 Docker 컨테이너를 `--network=none` 옵션으로 생성
2. 그 후 구성된 CNI 플러그인을 직접 호출하여 네트워킹 설정
3. 이를 통해 Docker를 사용하면서도 CNI 플러그인의 이점 활용 가능

## CNI 작동 방식 예시

### 컨테이너 생성 시

```
1. 컨테이너 런타임(예: Kubernetes)이 컨테이너 생성
2. 네트워크 네임스페이스 생성
3. CNI 플러그인 호출: bridge add <컨테이너ID> <네임스페이스>
4. 플러그인이 veth pair 생성 및 연결
5. 플러그인이 IP 주소 할당
6. 플러그인이 라우팅 구성
7. 결과를 런타임에 반환
```

### 컨테이너 삭제 시

```
1. 컨테이너 런타임이 컨테이너 삭제 시작
2. CNI 플러그인 호출: bridge del <컨테이너ID> <네임스페이스>
3. 플러그인이 네트워크 자원 정리
4. 컨테이너 런타임이 네임스페이스 제거
```

## CNI의 장점 요약

1. **표준화**: 모든 컨테이너 기술에서 동일한 네트워킹 방식 사용
2. **재사용성**: 한 번 개발된 플러그인을 여러 환경에서 사용 가능
3. **유연성**: 다양한 네트워킹 솔루션 선택 가능
4. **분리된 책임**: 컨테이너 런타임과 네트워킹 코드 분리
5. **생태계**: 다양한 3rd 파티 네트워킹 솔루션 활용 가능

## 쿠버네티스에서의 CNI

- 쿠버네티스는 CNI를 완벽하게 지원
- 클러스터 구성 시 사용할 CNI 플러그인 지정 가능
- 여러 CNI 플러그인 중 클러스터 환경에 적합한 것 선택 가능
- 별도 강의에서 쿠버네티스의 CNI 활용에 대해 더 자세히 다룰 예정

# 쿠버네티스 클러스터 네트워킹 구성

## 기본 네트워크 요구사항

### 노드 네트워크 설정

- 모든 마스터와 워커 노드는 최소 하나의 네트워크 인터페이스 필요
- 각 인터페이스에 IP 주소 설정 필요
- 각 노드는 고유한 호스트명 필요
- 각 노드는 고유한 MAC 주소 필요 (VM 복제 시 특히 주의)

```bash
# 네트워크 인터페이스 확인
ip link

# IP 주소 확인
ip addr

# 호스트명 확인
hostname

# MAC 주소 확인
ip link | grep ether
```

## 필수 포트 개방

### 마스터 노드 포트

|구성 요소|포트|용도|
|---|---|---|
|kube-apiserver|6443|API 서버 접근용 (kubectl, 외부 사용자, 컨트롤 플레인 구성 요소)|
|etcd|2379|etcd 클라이언트 통신|
|etcd|2380|etcd 서버간 통신 (다중 마스터 구성 시)|
|kubelet|10250|kubelet API|
|kube-scheduler|10259|스케줄러|
|kube-controller-manager|10257|컨트롤러 매니저|

### 워커 노드 포트

|구성 요소|포트|용도|
|---|---|---|
|kubelet|10250|kubelet API|
|NodePort 서비스|30000-32767|NodePort 서비스 외부 노출|

```bash
# 포트 확인
sudo netstat -tulpn | grep LISTEN

# 또는
sudo ss -tulpn | grep LISTEN
```

## 네트워크 플러그인 (CNI)

### CNI 개요

- 쿠버네티스는 네트워크 설정을 위해 CNI(Container Network Interface) 사용
- 클러스터 구성 시 네트워크 플러그인 설치 필요
- 클러스터에 파드를 배포하려면 CNI 플러그인이 반드시 설치되어야 함

### 주요 네트워크 플러그인

- **Weave Net**: 간편한 설치와 사용이 특징
- **Calico**: 네트워크 정책과 보안에 강점
- **Flannel**: 단순한 오버레이 네트워크
- **Cilium**: eBPF 기반 네트워킹 및 보안

### Weave Net 설치 예시

```bash
kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"
```

## CKA 시험 관련 참고사항

### 네트워크 애드온 배포

- 공식 쿠버네티스 문서에서 권장하는 네트워크 플러그인 사용 가능
- 시험에서 특별히 지정하지 않는 한 원하는 솔루션 선택 가능

### 시험 시 유의사항

- 공식 문서에는 서드파티 네트워크 애드온 배포 명령어가 직접 포함되어 있지 않음
- 시험에서는 필요한 CNI 배포 정보가 제공될 예정
- 외부 사이트나 GitHub 저장소는 시험 중 참조 불가

## 네트워크 구성 확인 및 문제 해결

### 노드 연결 확인

```bash
# 노드 상태 확인
kubectl get nodes

# 노드 세부 정보 확인
kubectl describe node <노드이름>
```

### 네트워크 플러그인 확인

```bash
# 네트워크 플러그인 파드 확인
kubectl get pods -n kube-system

# CNI 구성 확인
ls /etc/cni/net.d/
```

### 방화벽 확인

```bash
# iptables 규칙 확인
sudo iptables -L

# 클라우드 환경 보안 그룹 확인
# (AWS, GCP, Azure 관리 콘솔에서 확인)
```

## 실무 팁

### 클러스터 구축 시

- 노드 간 통신이 원활하도록 방화벽/보안그룹 설정
- 필요한 모든 포트 개방 확인
- IP 주소와 호스트명 충돌 없는지 확인

### 문제 해결 시

- 네트워크 플러그인이 정상 작동하는지 확인
- 마스터-워커 노드 간 통신 확인
- 필요한 포트가 모두 열려 있는지 확인

### 클라우드 환경 특이사항

- AWS: 보안 그룹 및 네트워크 ACL 설정 확인
- GCP: 방화벽 규칙 확인
- Azure: 네트워크 보안 그룹 설정 확인