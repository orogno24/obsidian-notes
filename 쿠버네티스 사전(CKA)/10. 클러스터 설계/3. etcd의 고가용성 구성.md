## etcd 개요 리뷰

- **etcd란?** 분산형, 신뢰할 수 있는 키-값 저장소로 단순하고, 안전하며, 빠른 특징을 가짐
- **전통적 데이터 저장 방식과 차이점:**
    - 전통적 방식: 테이블 형태로 데이터 저장
    - 키-값 저장소: 문서나 페이지 형태로 정보 저장
    - 복잡한 데이터는 주로 JSON이나 YAML 형식으로 처리

## etcd의 분산 시스템 구성

- 여러 서버에 걸쳐 데이터 저장 가능
- 모든 노드가 동일한 데이터베이스 사본 유지
- 한 노드가 실패해도 데이터 손실 없음

## 데이터 일관성 유지 메커니즘

### 읽기 작업(Read)

- 모든 노드에 동일한 데이터가 있어 어느 노드에서든 읽기 가능

### 쓰기 작업(Write)

- 모든 노드가 직접 쓰기를 처리하지 않음
- **리더-팔로워 모델** 사용:
    - 하나의 노드가 리더로 선출됨
    - 나머지 노드는 팔로워 역할
    - 리더만 쓰기 처리 담당
    - 팔로워로 들어온 쓰기 요청은 내부적으로 리더에게 전달
    - 쓰기는 리더가 다른 노드의 동의를 얻은 후에만 완료됨

## Raft 프로토콜

etcd는 분산 합의(distributed consensus)를 위해 Raft 프로토콜 구현:

### 리더 선출 과정

1. 클러스터 초기 설정 시 리더가 없는 상태로 시작
2. 각 노드에서 무작위 타이머 시작
3. 타이머가 가장 먼저 끝난 노드가 다른 노드에 리더 권한 요청
4. 다른 노드들이 투표로 응답
5. 과반수 투표를 받은 노드가 리더 역할 수행
6. 리더는 정기적으로 다른 노드에 리더 역할 계속함을 알림
7. 알림이 중단되면 다른 노드들이 재선출 프로세스 시작

### 쓰기 작업 처리

1. 리더가 쓰기 요청 처리
2. 클러스터의 다른 노드에 복제
3. **과반수(쿼럼)** 노드에 쓰기 성공 시 완료로 간주
4. 오프라인 노드가 다시 온라인 상태가 되면 데이터 복사

## 쿼럼(Quorum)과 장애 허용(Fault Tolerance)

- **쿼럼**: 클러스터가 정상 작동하기 위해 필요한 최소 노드 수
- **계산 공식**: (전체 노드 수 ÷ 2) + 1 (소수점은 버림)
- **노드 수에 따른 쿼럼**:

|노드 수|쿼럼|장애 허용|
|---|---|---|
|1|1|0|
|2|2|0|
|3|2|1|
|4|3|1|
|5|3|2|
|6|4|2|
|7|4|3|
- **최소 권장 노드 수**: 3개 (HA 환경에서)
- **홀수 vs 짝수**: 홀수 권장
    - 네트워크 분할 시 홀수가 쿼럼 유지에 유리
    - 예: 6개 노드가 3-3으로 분할되면 쿼럼(4) 충족 불가
    - 예: 7개 노드가 4-3으로 분할되면 4개 그룹이 쿼럼(4) 충족
- **권장 노드 수**: 3개 또는 5개
    - 3개: 기본 구성, 1개 노드 장애 허용
    - 5개: 더 높은 내구성, 2개 노드 장애 허용
    - 7개 이상: 대부분의 경우 불필요

## etcd 설치 및 구성

1. 최신 지원 바이너리 다운로드 및 압축 해제
2. 필요한 디렉토리 구조 생성
3. etcd용 생성된 인증서 파일 복사
4. etcd 서비스 구성
    - `initial-cluster` 옵션에 피어 정보 포함하여 클러스터 구성

## etcd 사용법

- **API 버전**: V2(기본값), V3
- V3 사용 시 환경 변수 설정: `export ETCDCTL_API=3`
- **기본 명령어**:
    - 데이터 저장: `etcdctl put <키> <값>`
    - 데이터 검색: `etcdctl get <키>`
    - 모든 키 검색: `etcdctl get --keys-only`

## 설계 고려사항

- HA 환경에서는 최소 3개의 노드 필요
- 홀수 개의 노드 권장 (3, 5, 7)
- 환경, 장애 허용 요구사항 및 비용에 따라 적절한 노드 수 선택
- 실습 환경 제약으로 2개의 마스터 노드만 사용 (실제 환경에서는 3개 권장)
- 스택형 토폴로지 선택 (마스터 노드에 etcd 서버 구성)

---

## 추가 참고사항

- etcd의 분산 특성은 고가용성 쿠버네티스 클러스터 구축의 핵심 요소
- 데이터 일관성과 고가용성을 동시에 보장하는 설계 필요
- 네트워크 분할 시나리오를 고려한 노드 수 선택이 중요
- 리더 선출 및 쿼럼 확보 메커니즘 이해가 시스템 설계에 필수적