
노드 유지보수는 쿠버네티스 클러스터에서 필수적인 운영 작업입니다. 기본 소프트웨어 업그레이드, 보안 패치 적용, 하드웨어 유지보수 등의 이유로 노드를 일시적으로 중단해야 할 수 있습니다.

### 노드 장애 발생 시 시나리오
노드가 예기치 않게 다운되면 다음과 같은 상황이 발생합니다:

1. **파드 접근성 손실**: 해당 노드에서 실행 중이던 파드에 접근할 수 없게 됨
2. **사용자 영향**:
    - 여러 복제본이 있는 애플리케이션은 다른 노드의 파드가 요청을 처리하므로 최소한의 영향
    - 단일 인스턴스 애플리케이션은 완전히 중단됨

> 💡 **중요**: 애플리케이션의 고가용성을 위해서는 항상 여러 노드에 걸쳐 여러 복제본을 실행하는 것이 좋습니다.

### 쿠버네티스의 노드 장애 처리

1. **노드 즉시 복구 시나리오**:
    - 노드가 즉시 다시 온라인 상태가 되면 kubelet 프로세스가 시작됨
    - 기존 파드들이 다시 온라인 상태로 전환됨
    
2. **지연된 복구 시나리오**:
    - 노드가 5분 이상 다운되면 파드가 해당 노드에서 종료된 것으로 간주됨
    - 이 시간은 `pod-eviction-timeout`으로 알려져 있으며 컨트롤러 매니저에 설정됨
    - 기본값은 5분
    
3. **노드 복구 후**:
    - 타임아웃 후 노드가 복구되면 파드 없이 빈 상태로 시작됨
    - 레플리카셋에 속한 파드는 다른 노드에 자동으로 재생성됨
    - 단일 파드(레플리카셋에 속하지 않은)는 영구적으로 손실됨

## 2. 계획된 유지보수: 드레이닝(Draining)

예정된 유지보수 작업을 위해 노드를 안전하게 오프라인 상태로 전환하는 방법은 드레이닝(Draining)입니다.

### 드레이닝 프로세스

1. **파드 안전하게 종료**: 노드에서 실행 중인 모든 파드를 정상적으로 종료
2. **워크로드 이동**: 레플리카셋에 속한 파드는 다른 노드에 재생성됨
3. **노드 스케줄 불가 설정**: 노드가 `Unschedulable` 상태로 표시됨(코도닝/Cordoning)

```bash
# 노드 드레이닝
kubectl drain node-1 --ignore-daemonsets
```

> ⚠️ **주의**: `--ignore-daemonsets` 플래그는 데몬셋에 의해 관리되는 파드(예: kube-proxy, CNI 네트워킹 파드)를 무시합니다. 이러한 파드는 모든 노드에 필요하므로 제거할 수 없습니다.

### 드레이닝 후 작업

1. **유지보수 수행**: 필요한 유지보수 작업 수행(업그레이드, 패치 등)
2. **노드 재시작**: 필요한 경우 노드 재부팅
3. **언코도닝(Uncordoning)**: 노드를 다시 스케줄 가능한 상태로 표시

```bash
# 노드 언코도닝
kubectl uncordon node-1
```

> 📝 **참고**: 드레이닝으로 다른 노드로 이동된 파드는 자동으로 원래 노드로 돌아오지 않습니다. 새 파드가 생성되거나 기존 파드가 삭제된 경우에만 언코도닝된 노드에 스케줄링될 수 있습니다.

## 3. 코도닝(Cordoning)

코도닝은 노드를 `Unschedulable` 상태로 표시하는 과정으로, 드레이닝과 달리 기존 파드를 종료하지 않습니다.

### 코도닝 사용 시나리오

- 새로운 파드가 특정 노드에 스케줄링되는 것을 방지
- 노드에서 현재 실행 중인 파드는 계속 실행되도록 유지
- 점진적인 유지보수 준비 단계

```bash
# 노드 코도닝
kubectl cordon node-1
```

### 코도닝과 드레이닝 비교

|기능|코도닝|드레이닝|
|---|---|---|
|새 파드 스케줄링 방지|✅|✅|
|기존 파드 종료|❌|✅|
|워크로드 다른 노드로 이동|❌|✅|
|유지보수 준비에 적합|점진적 준비|즉시 유지보수|

## 4. 유지보수 전략 선택

### 단기 유지보수 (5분 미만)

타임아웃 내에 노드가 돌아올 것이 확실하고, 일시적인 워크로드 중단이 허용되는 경우:

1. 레플리카셋으로 관리되지 않는 중요 파드가 없는지 확인
2. 빠른 업그레이드 및 재부팅 수행

### 장기 유지보수 (5분 이상)

대부분의 유지보수 작업에 권장되는 접근 방식:

1. 노드 드레이닝
2. 유지보수 수행
3. 노드 재시작
4. 노드 언코도닝

### 점진적 유지보수 준비

유지보수를 준비하는 동안 노드에 새 워크로드를 할당하지 않으려는 경우:

1. 노드 코도닝
2. 기존 워크로드가 완료될 때까지 대기
3. 완료 후 드레이닝 또는 직접 유지보수 수행

## 5. 모범 사례 및 주의사항

### 모범 사례

1. **롤링 업데이트 접근 방식**: 한 번에 하나의 노드만 유지보수하여 클러스터 용량 유지
2. **PodDisruptionBudget 사용**: 애플리케이션에 PDB를 설정하여 동시에 중단될 수 있는 파드 수 제한
3. **사전 테스트**: 중요한 클러스터에서 유지보수 전 테스트 환경에서 절차 검증
4. **여유 용량 확보**: 드레이닝 시 다른 노드가 추가 워크로드를 처리할 충분한 용량 확보

### 주의사항

1. **단일 파드 확인**: 레플리카셋이 없는 단일 파드는 드레이닝 시 재생성되지 않음
2. **PV 사용 파드**: 로컬 볼륨을 사용하는 파드는 다른 노드로 이동할 수 없음
3. **데몬셋 처리**: 드레이닝 시 `--ignore-daemonsets` 플래그 사용 필요
4. **로컬 스토리지**: `--delete-local-data` 플래그로 로컬 스토리지 처리 방법 지정 가능
5. **강제 종료**: 문제가 있는 파드는 `--force` 플래그로 강제 종료 가능 (주의 필요)

### 유용한 명령어

```bash
# 노드 상태 확인
kubectl get nodes

# 특정 노드에서 실행 중인 파드 확인
kubectl get pods --all-namespaces -o wide --field-selector spec.nodeName=node-1

# 드레이닝 (강제 옵션 포함)
kubectl drain node-1 --ignore-daemonsets --delete-local-data --force

# 노드 상세 정보 확인
kubectl describe node node-1
```

## 요약

- 노드 유지보수는 클러스터 관리의 중요한 부분입니다.
- 예기치 않은 노드 장애 시 쿠버네티스는 5분(기본값) 동안 대기한 후 파드를 다른 노드로 이동시킵니다.
- 계획된 유지보수의 경우 `drain` 명령어를 사용하여 노드를 안전하게 비우고, 유지보수 후 `uncordon` 명령어로 다시 활성화합니다.
- `cordon` 명령어는 노드를 스케줄 불가능으로 표시하지만 기존 파드는 계속 실행됩니다.
- 고가용성을 위해 항상 여러 노드에 걸쳐 여러 복제본을 실행하는 애플리케이션 설계가 중요합니다.