## 1. 구성 요소 버전 호환성

쿠버네티스 클러스터의 각 구성 요소는 서로 다른 버전을 가질 수 있지만, 특정 버전 호환성 규칙을 따라야 합니다.

### 버전 스큐(Version Skew) 정책

- **kube-apiserver**: 클러스터의 기준점이 되는 구성 요소
- **컨트롤러 매니저 & 스케줄러**: kube-apiserver보다 최대 1개 마이너 버전 낮을 수 있음
- **kubelet & kube-proxy**: kube-apiserver보다 최대 2개 마이너 버전 낮을 수 있음
- **kubectl**: kube-apiserver보다 1개 마이너 버전 높거나, 같거나, 1개 마이너 버전 낮을 수 있음

> 💡 **중요**: 어떤 구성 요소도 kube-apiserver보다 높은 버전이어서는 안 됩니다(kubectl 제외).

### 예시

kube-apiserver가 1.10 버전인 경우:
- 컨트롤러 매니저 & 스케줄러: 1.10 또는 1.9
- kubelet & kube-proxy: 1.10, 1.9 또는 1.8
- kubectl: 1.11, 1.10 또는 1.9

이러한 버전 스큐 정책은 라이브 업그레이드를 가능하게 합니다.

## 2. 업그레이드 타이밍 및 지원 정책

### 지원 정책

- 쿠버네티스는 최근 3개의 마이너 버전만 공식 지원합니다
- 예: 1.12가 최신 버전이면 1.12, 1.11, 1.10만 지원됨
- 1.13이 출시되면 1.13, 1.12, 1.11만 지원되고 1.10은 지원 중단

### 업그레이드 시기

- 지원 중단 전에 업그레이드하는 것이 좋음
- 예: 1.10을 사용 중이고 1.13 출시가 임박했다면, 1.10이 지원 중단되기 전에 업그레이드 계획 수립

### 업그레이드 경로

- **권장 접근 방식**: 한 번에 하나의 마이너 버전씩 업그레이드
- 예: 1.10 → 1.11 → 1.12 → 1.13
- **비권장**: 여러 마이너 버전을 한 번에 건너뛰는 것(예: 1.10 → 1.13)

## 3. 업그레이드 방법

### 배포 방식에 따른 업그레이드 방법

1. **관리형 쿠버네티스 서비스(GKE, EKS, AKS 등)**    
    - 클라우드 제공업체의 콘솔이나 API를 통해 간단히 업그레이드
    - 대부분 백그라운드에서 롤링 업데이트 방식으로 진행
    
2. **kubeadm으로 배포한 클러스터**
    - kubeadm 도구를 사용하여 업그레이드 계획 및 실행
    - 강의에서 주로 다루는 방식
    
3. **직접 설치한 클러스터**
    - 각 구성 요소를 수동으로 업그레이드해야 함
    - 복잡하고 세심한 계획 필요

## 4. 클러스터 업그레이드 과정

### 업그레이드 단계

클러스터 업그레이드는 두 가지 주요 단계로 구성됩니다:

1. **마스터 노드 업그레이드**
2. **워커 노드 업그레이드**

### 마스터 노드 업그레이드 시 영향

- 컨트롤 플레인 구성 요소(API 서버, 스케줄러, 컨트롤러 매니저)가 잠시 중단됨
- **영향**:
    - 워커 노드와 애플리케이션은 계속 실행됨
    - 관리 기능만 일시적으로 중단(kubectl 액세스, 새 배포, 변경 불가)
    - 컨트롤러가 작동하지 않아 파드 자동 복구 불가능
    - 사용자 트래픽은 영향받지 않음(기존 애플리케이션 계속 작동)

> ⚠️ **주의**: 마스터 업그레이드 중에는 클러스터 관리가 불가능하므로 안정적인 상태에서 수행해야 합니다.

## 5. 워커 노드 업그레이드 전략

### 1. 한 번에 모든 노드 업그레이드

- **장점**: 빠른 업그레이드 완료
- **단점**: 모든 애플리케이션 중단, 서비스 불가능 상태 발생
- **적합한 경우**: 개발/테스트 환경, 다운타임이 허용되는 애플리케이션

### 2. 순차적 노드 업그레이드(롤링 업데이트)

1. 첫 번째 노드 드레이닝(워크로드를 다른 노드로 이동)
2. 첫 번째 노드 업그레이드
3. 업그레이드된 노드를 클러스터에 다시 추가
4. 다음 노드에 대해 1-3 단계 반복

- **장점**: 다운타임 없음, 사용자 영향 최소화
- **단점**: 더 오래 걸림, 임시로 클러스터 용량 감소
- **적합한 경우**: 프로덕션 환경, 고가용성 필요 애플리케이션

### 3. 새 노드 추가 전략

1. 새로운 버전의 소프트웨어가 설치된 새 노드 추가
2. 워크로드를 새 노드로 점진적으로 이동
3. 이전 노드 제거

- **장점**: 안전한 롤백 가능, 용량 유지
- **단점**: 추가 리소스 필요, 클라우드 환경에 더 적합
- **적합한 경우**: 클라우드 환경, 자동화된 인프라

## 6. kubeadm을 사용한 업그레이드 예시

이 예시에서는 쿠버네티스 클러스터를 1.11에서 1.13으로 업그레이드합니다.

### 업그레이드 계획 확인

```bash
kubeadm upgrade plan
```

이 명령어는 다음 정보를 제공합니다:

- 현재 클러스터 버전
- kubeadm 도구 버전
- 최신 안정 버전
- 각 구성 요소의 버전과 업그레이드 가능한 버전
- 업그레이드 명령어 제안

> 📝 **참고**: kubeadm은 kubelet을 설치하거나 업그레이드하지 않으므로 나중에 수동으로 업그레이드해야 합니다.

### 마스터 노드 업그레이드 (1.11 → 1.12)

1. **kubeadm 도구 업그레이드**
    
    ```bash
    # apt-get을 사용하는 경우
    apt-get update
    apt-get install -y kubeadm=1.12.x-00
    ```
    
2. **클러스터 업그레이드 적용**
    
    ```bash
    kubeadm upgrade apply v1.12.x
    ```
    
    이 명령어는 필요한 이미지를 가져오고 클러스터 구성 요소를 업그레이드합니다.
    
3. **kubelet 업그레이드(마스터 노드에 kubelet이 있는 경우)**
    
    ```bash
    apt-get install -y kubelet=1.12.x-00
    systemctl restart kubelet
    ```
    
4. **업그레이드 확인**
    
    ```bash
    kubectl get nodes
    ```
    
    마스터 노드가 이제 1.12로 업그레이드되었지만 워커 노드는 여전히 1.11입니다.
    

### 워커 노드 순차 업그레이드

각 워커 노드에 대해 다음 단계를 수행합니다:

1. **노드 드레이닝**
    
    ```bash
    kubectl drain node-1 --ignore-daemonsets
    ```
    
    이 명령어는:
    - 노드에서 모든 파드를 안전하게 종료
    - 파드를 다른 노드로 재스케줄링
    - 노드를 스케줄 불가능으로 표시

2. **kubeadm 및 kubelet 업그레이드**
    
    ```bash
    # 워커 노드에서
    apt-get update
    apt-get install -y kubeadm=1.12.x-00
    apt-get install -y kubelet=1.12.x-00
    ```
    
3. **노드 구성 업그레이드**
    
    ```bash
    kubeadm upgrade node
    ```
    
4. **kubelet 재시작**
    
    ```bash
    systemctl restart kubelet
    ```
    
5. **노드 스케줄 가능 상태로 복원**
    
    ```bash
    kubectl uncordon node-1
    ```
    
6. 다른 모든 워커 노드에 대해 1-5단계를 반복함


### 1.12에서 1.13으로 업그레이드

위의 모든 단계를 반복하여 클러스터를 1.12에서 1.13으로 업그레이드합니다.

## 7. 업그레이드 모범 사례

1. **사전 계획**
    - 업그레이드 전 항상 클러스터 백업
    - 먼저 테스트 환경에서 업그레이드 테스트
    - 변경 로그 및 알려진 이슈 확인
    
2. **워크로드 고려사항**
    - PodDisruptionBudget을 사용하여 동시에 중단되는 파드 수 제한
    - StatefulSet 및 로컬 스토리지 파드에 주의
    
3. **업그레이드 중 모니터링**
    - 업그레이드 진행 상황 모니터링
    - 구성 요소 상태 및 로그 확인
    - 애플리케이션 가용성 모니터링
    
4. **롤백 계획**
    - 문제 발생 시 롤백 절차 준비
    - 이전 상태로 복원할 수 있는 백업 유지

## 요약

- 쿠버네티스 업그레이드는 마스터 노드부터 시작하여 워커 노드로 진행됩니다.
- 버전 스큐 정책을 준수하여 한 번에 한 마이너 버전씩 업그레이드합니다.
- 워커 노드 업그레이드 전략에는 모든 노드 동시 업그레이드, 순차적 업그레이드, 새 노드 추가 방식이 있습니다.
- kubeadm은 업그레이드 계획 및 실행을 위한 유용한 도구를 제공합니다.
- 업그레이드 과정에서 적절한 계획과 주의를 통해 다운타임 없이 클러스터를 최신 상태로 유지할 수 있습니다.