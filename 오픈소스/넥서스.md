## Nexus Repository란?

**멀티포맷 아티팩트 저장소** - 개발에 필요한 모든 라이브러리와 파일을 중앙에서 관리하는 도구
### 왜 필요한가?

```
문제: 개발자들이 각자 외부에서 라이브러리 다운로드
해결: 내부 서버에 모아두고 한 곳에서 관리
```
### 기본 vs Nexus

```yaml
기본 방식:
  개발자 → Maven Central (외부) → 라이브러리 다운로드

Nexus 방식:
  개발자 → Nexus (내부) → Maven Central → 라이브러리 다운로드
          ↑ 캐시/관리      ↑ 첫 번째만
```

## 주요 기능

### 1. **프록시 & 캐싱**

- 외부 저장소(Maven Central, npm Registry)의 캐시 역할
- 한 번 다운로드하면 내부에서 재사용

### 2. **멀티포맷 지원**

- Docker 이미지
- Maven (Java)
- npm (Node.js)
- PyPI (Python)
- NuGet (.NET)
- Helm 차트

### 3. **사내 라이브러리 저장**

- 내부에서 개발한 라이브러리 공유
- 팀 간 코드 재사용

## 사용 시나리오

### **개인/소규모 팀**

```
사용 안함 (95%)
→ Maven Central 직접 사용
→ 설정 간단, 비용 없음
```

### **중대형 기업**

```
사용함 (80%)
→ 보안 정책, 망분리 환경
→ 네트워크 효율성, 통제 필요
```

## 실제 설정 예시

### **Maven 설정**

```xml
<!-- pom.xml -->
<project>
    <!-- Repository 설정: 어디서 가져올지 -->
    <repositories>
        <repository>
            <id>nexus</id>
            <url>http://nexus.company.com:8081/repository/maven-public/</url>
        </repository>
    </repositories>
    
    <!-- 의존성 선언: 무엇을 가져올지 -->
    <dependencies>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-core</artifactId>
            <version>5.3.21</version>
        </dependency>
    </dependencies>
</project>
```

### 빌드 시 동작

```bash
mvn clean compile
↓
Maven: pom.xml에서 의존성 목록 확인
↓  
Maven: "spring-core 5.3.21이 필요하네"
↓
Maven: Repository 설정 확인 → Nexus 서버 접근
↓
Nexus: spring-core 있는지 확인
  - 있으면: 바로 전달
  - 없으면: Maven Central에서 다운로드 후 캐시하고 전달
↓
빌드 완료
```

## 장단점

### **장점**

- 🚀 빠른 다운로드 (내부 네트워크)
- 🔒 보안 통제 (승인된 라이브러리만)
- 📦 통합 관리 (모든 아티팩트 한 곳에)
- 🏢 사내 라이브러리 공유

### **단점**

- 💰 비용 (서버, 관리 인력)
- ⚙️ 설정 복잡성
- 🔧 유지보수 필요

## 경쟁 제품 비교

|제품|특징|사용 환경|
|---|---|---|
|**Nexus**|멀티포맷, 기업급|대기업, CI/CD 중심|
|**Harbor**|컨테이너 전문|쿠버네티스 환경|
|**Docker Hub**|퍼블릭 클라우드|개인, 소규모|

## 핵심 포인트

```yaml
언제 사용?: 
  - 기업 환경 (보안 정책)
  - 팀 규모 큼 (효율성)
  - 망분리 환경 (접근 제한)
  - 사내 라이브러리 공유

왜 사용?:
  - 의존성 "정보"는 코드에, "파일"은 별도 관리
  - 외부 의존성 없는 안정적 빌드
  - 중앙집중식 아티팩트 관리
```

**한줄 요약**: 개발팀의 모든 라이브러리를 안전하고 효율적으로 관리하는 내부 저장소

---
# 📝 Nexus Docker Registry 운영 메모

## 🎯 목표

쿠버네티스 환경에서 Nexus를 Docker 이미지 저장소로 사용하고, 기존 VM에서 관리하던 이미지를 새 환경으로 안전하게 이전한다.

## 🟢 Nexus 설치 구조

### ✅ 기존 VM Nexus

- 회사에서 직접 VM에 Nexus를 설치해 운영.
- 접속 URL:
    ```
    https://14.63.177.157:8443/
    ```
- Repository에 기존 Docker 이미지가 저장되어 있음.
- 목적: **이 이미지들을 파드로 배포된 Nexus로 마이그레이션**

---

### ✅ 쿠버네티스 Nexus

- Helm Chart로 설치
    
- 서비스 노출 방식:
    
    - NodePort 30018 (HTTP Docker Port)
        
    - NodePort 30443 (HTTPS Docker Port)
        
    - ClusterIP 8081 (웹 UI/REST API)
        
- Ingress도 배포되어 있으나 EXTERNAL-IP는 없음 (NodePort만 노출 중)
    

---

## 🟢 마이그레이션 목적

- 기존 VM Nexus에 저장된 이미지 정보를 **쿠버네티스 Nexus로 이전**.
    
- 새 환경에 동일한 이미지 네임과 태그로 저장.
    
- 이후 구축된 쿠버네티스 클러스터에서 일관되게 Pull 가능.
    

---

## 🟢 마이그레이션 전략

✅ **기본 원리**

1. 기존 VM Nexus에서 `docker pull`로 이미지를 내려받음.
    
2. 쿠버네티스 Nexus에 `docker tag`로 새 경로를 지정.
    
3. `docker push` 또는 `nerdctl push`로 업로드.
    

✅ **주의**

- VM Nexus는 HTTPS 포트(`8443`)에 연결되어야 함.
    
- 쿠버네티스 Nexus는 NodePort 방식(30018/30443) 또는 Ingress Subpath를 통해 접속 가능.
    

---

## 🟢 마이그레이션 예제

아래는 `nginx:latest`를 VM Nexus에서 쿠버네티스 Nexus로 옮기는 예시.

---

### ① VM Nexus에서 Pull

```bash
docker login 14.63.177.157:8443
docker pull 14.63.177.157:8443/nginx:latest
```

(또는 `nerdctl` 사용 가능)

---

### ② 쿠버네티스 Nexus로 Tag

- NodePort(HTTP) 방식 예시:
    
    ```bash
    sudo nerdctl tag 14.63.177.157:8443/nginx:latest 172.25.0.84:30018/myimage/nginx:latest
    ```
    
- Ingress 방식 예시:
    
    ```bash
    sudo nerdctl tag 14.63.177.157:8443/nginx:latest repository.dev.eris.go.kr/my-docker-image/nginx:latest
    ```
    

---

### ③ Push

- NodePort(HTTP) 방식:
    
    ```bash
    sudo nerdctl --plain-http push 172.25.0.84:30018/myimage/nginx:latest
    ```
    
- Ingress Subpath 방식:
    
    ```bash
    sudo nerdctl push repository.dev.eris.go.kr/my-docker-image/nginx:latest
    ```
    

---

✅ 마이그레이션 대상 이미지:

- `quay.io/jaegertracing/jaeger-operator:1.65.0`
    
- `gcr.io/kubebuilder/kube-rbac-proxy:v0.13.1`
    
- `jaegertracing/jaeger-agent:1.62.0`
    
- `jaegertracing/jaeger-collector:1.65.0`
    
- `jaegertracing/jaeger-es-index-cleaner:1.65.0`
    
- `jaegertracing/jaeger-query:1.65.0`
    
- `docker.elastic.co/elasticsearch/elasticsearch:8.12.2`
    

모두 동일 방식으로 Tag 및 Push.

---

## 🟢 Repository 구분 방식

**NodePort 방식**

- Repository는 고정 (`okestro-docker`)
    
- 이미지 경로는 단순 Prefix 구분  
    예: `myimage/nginx:latest`
    

**Ingress Subpath 방식**

- Repository를 URL로 구분  
    예: `my-docker-image/nginx:latest`
    
- 다양한 Repository에 저장 가능
    

---

## 🟢 DNS와 /etc/hosts 주의사항

✅ Subpath 방식 사용 시:

```
/etc/hosts:
172.25.0.96 repository.dev.eris.go.kr
```

(Ingress Node IP)

✅ NodePort 방식 사용 시:

```
/etc/hosts:
172.25.0.84 repository.dev.eris.go.kr
```

(마스터노드 IP)

---

## 🟢 인증서 및 보안

- VM Nexus: 자체 서명 인증서 사용
    
- 쿠버네티스 Nexus: 기본 인증서
    
- NodePort HTTP 사용 시 `--plain-http` 필요
    
- HTTPS 사용 시 `insecure-registries` 설정 필요
    

예시:

```json
{
  "insecure-registries": ["repository.dev.eris.go.kr"]
}
```

Docker 재시작 후 적용.

---

## 🟢 자주 발생하는 문제와 대응

✅ HTTP/HTTPS 혼동

- `http: server gave HTTP response to HTTPS client`  
    → `--plain-http` 옵션 필요
    

✅ Subpath가 안됨

- DNS 또는 `/etc/hosts`가 NodePort로 연결됨
    
- 반드시 Ingress Node나 LoadBalancer에 연결해야 Subpath 정상 동작
    

✅ 인증서 CN/SAN 문제

- `x509: certificate signed by unknown authority`  
    → `insecure-registries` 등록 또는 `--tls-verify=false`
    

---

## 🟢 운영 권장사항

- 테스트 환경: NodePort + `--plain-http`
    
- 운영 환경: Ingress + LoadBalancer + Subpath
    
- 마이그레이션 완료 후 VM Nexus는 `Read-Only`로 두어 데이터 보존
    

---

필요하시면 이 문서에 예제 더 추가해 드리겠습니다. 🚀✨