좋습니다! PVC 이름과 마운트 경로를 확인했네요. 이제 백업을 진행해보겠습니다.

## 1. 원본 Nexus 데이터 백업

### 1.1 백업용 Pod 생성### 1.2 백업 실행

```bash
# 백업 Pod 생성
kubectl apply -f cicd-backup-pod.yaml

# Pod 준비 대기
kubectl wait --for=condition=ready pod/nexus-backup-pod -n cicd --timeout=60s

# 데이터 크기 확인 (참고용)
kubectl exec -n cicd nexus-backup-pod -- du -sh /nexus-data

# 데이터 압축 (시간이 좀 걸릴 수 있습니다)
echo "백업 시작... (시간이 걸릴 수 있습니다)"
kubectl exec -n cicd nexus-backup-pod -- tar czf /tmp/nexus-backup.tar.gz -C /nexus-data .

# 압축 파일 크기 확인
kubectl exec -n cicd nexus-backup-pod -- ls -lh /tmp/nexus-backup.tar.gz

# 로컬로 복사
kubectl cp cicd/nexus-backup-pod:/tmp/nexus-backup.tar.gz ./nexus-backup.tar.gz

# 로컬 백업 파일 확인
ls -lh nexus-backup.tar.gz

# 백업 Pod 삭제
kubectl delete pod nexus-backup-pod -n cicd
```

## 2. 새로운 Nexus 설치를 위한 준비

### 2.1 원본 Nexus의 Helm values 확인

```bash
# 원본 설정 확인
helm get values nexus -n cicd > original-nexus-values.yaml
cat original-nexus-values.yaml

# 더 자세한 설정 보기
helm get values nexus -n cicd --all > original-nexus-values-all.yaml
```

### 2.2 새 Nexus용 values 파일 생성## 3. 새 Nexus 설치

```bash
# 새 namespace 생성
kubectl create namespace nexus-restore-test

# Helm repo 확인
helm repo list | grep sonatype || helm repo add sonatype https://sonatype.github.io/helm3-charts/
helm repo update

# 새 Nexus 설치
helm install nexus-new sonatype/nexus-repository-manager \
  -n nexus-restore-test \
  -f new-nexus-values.yaml \
  --version 64.2.0

# 설치 확인
kubectl get all -n nexus-restore-test
kubectl get pvc -n nexus-restore-test
```

## 4. 새 Nexus PV에 데이터 복원

### 4.1 새 Nexus 중지 및 복원 준비

```bash
# 새 Nexus의 PVC 이름 확인
kubectl get pvc -n nexus-restore-test

# Pod 이름 확인
kubectl get pods -n nexus-restore-test

# Deployment를 0으로 scale down (데이터 무결성을 위해)
kubectl scale deployment -n nexus-restore-test nexus-new-nexus-repository-manager --replicas=0

# Scale down 완료 확인
kubectl get pods -n nexus-restore-test
```

### 4.2 복원용 Pod 생성### 4.3 데이터 복원

```bash
# PVC 이름 재확인 후 restore-pod.yaml 수정 필요
kubectl get pvc -n nexus-restore-test -o name | grep nexus

# 복원 Pod 생성
kubectl apply -f restore-pod.yaml

# Pod 준비 대기
kubectl wait --for=condition=ready pod/nexus-restore-pod -n nexus-restore-test

# 기존 데이터 확인 및 삭제
kubectl exec -n nexus-restore-test nexus-restore-pod -- ls -la /nexus-data
kubectl exec -n nexus-restore-test nexus-restore-pod -- rm -rf /nexus-data/*

# 백업 파일 복사
kubectl cp ./nexus-backup.tar.gz nexus-restore-test/nexus-restore-pod:/tmp/nexus-backup.tar.gz

# 압축 해제
echo "복원 시작... (시간이 걸릴 수 있습니다)"
kubectl exec -n nexus-restore-test nexus-restore-pod -- tar xzf /tmp/nexus-backup.tar.gz -C /nexus-data

# 복원된 데이터 확인
kubectl exec -n nexus-restore-test nexus-restore-pod -- ls -la /nexus-data

# 권한 설정 (중요!)
kubectl exec -n nexus-restore-test nexus-restore-pod -- chown -R 997:997 /nexus-data

# 복원 Pod 삭제
kubectl delete pod nexus-restore-pod -n nexus-restore-test
```

## 5. 새 Nexus 재시작 및 확인

```bash
# Deployment 재시작
kubectl scale deployment -n nexus-restore-test nexus-new-nexus-repository-manager --replicas=1

# Pod 시작 확인
kubectl get pods -n nexus-restore-test -w

# 로그 확인
kubectl logs -n nexus-restore-test -l app.kubernetes.io/name=nexus-repository-manager -f
```

## 6. 복원 검증

### 6.1 서비스 정보 확인

```bash
# 서비스 및 포트 확인
echo "=== 원본 Nexus (cicd) ==="
kubectl get svc -n cicd nexus-nexus-repository-manager

echo -e "\n=== 새 Nexus (nexus-restore-test) ==="
kubectl get svc -n nexus-restore-test
```

### 6.2 웹 UI 접속 테스트

```bash
# NodePort 확인
kubectl get svc -n nexus-restore-test nexus-new-nexus-repository-manager -o jsonpath='{.spec.ports[0].nodePort}'

# 노드 IP 확인
kubectl get nodes -o wide

# 브라우저에서 접속: http://<노드IP>:32081
# 원본과 동일한 admin 계정으로 로그인
```

### 6.3 데이터 확인

1. 웹 UI에서:
    - Repository 목록 확인
    - Browse에서 기존 아티팩트 확인
    - 설정들이 유지되었는지 확인

2. API로 확인:

```bash
# Repository 목록 조회 (admin 패스워드 필요)
curl -u admin:<패스워드> http://<노드IP>:32081/service/rest/v1/repositories
```

## 7. 정리 작업 (선택사항)

테스트가 성공적으로 완료되면:

```bash
# 테스트용 Nexus 삭제
helm uninstall nexus-new -n nexus-restore-test

# namespace 삭제
kubectl delete namespace nexus-restore-test

# 백업 파일 보관 또는 삭제
# rm nexus-backup.tar.gz
```

이렇게 하면 NFS 기반 PVC를 사용하는 Helm으로 설치된 Nexus의 데이터를 성공적으로 백업하고 복원할 수 있습니다. 특히 `okestro-nfs-retain` StorageClass를 사용하고 있어서 데이터가 안전하게 보관될 것입니다.

  이 메시지는 사용자 PC의 Docker가 `https://repository.dev.eris.go.kr`의 HTTPS(TLS) 인증서를 신뢰할 수
  없다는 의미입니다. 아마도 해당 저장소는 공인된 인증서가 아닌, 내부용으로 생성된 사설 인증서나 자가 서명
  인증서(self-signed certificate)를 사용하고 있을 것입니다.


  docker login은 성공했지만 push에서 실패하는 이유는, login 시점에는 인증서 검증이 느슨하게 동작할 수 있지만
   실제 데이터 전송(push) 시점에는 엄격한 검증을 요구하기 때문입니다.

  해결 방법


  사용자 PC의 Docker에게 repository.dev.eris.go.kr는 안전하지 않은(insecure) 레지스트리로 취급하라고
  명시적으로 알려주어, 이 인증서 검증 과정을 건너뛰도록 설정해야 합니다.

  Docker Desktop (Windows) 설정 방법:


   1. Windows 작업 표시줄에서 Docker Desktop 아이콘을 마우스 오른쪽 버튼으로 클릭하고 Settings를 선택합니다.
   2. 왼쪽 메뉴에서 Docker Engine으로 이동합니다.
   3. 오른쪽에 보이는 JSON 설정 파일에 insecure-registries 항목을 추가합니다.


      만약 파일이 비어있거나 다른 내용이 있다면, 아래와 같이 수정해주세요. 기존에 다른 내용이 있다면
  쉼표(,)를 사용해 문법에 맞게 추가해야 합니다.



    1     {
    2       "builder": {
    3         "gc": {
    4           "defaultKeepStorage": "20GB",
    5           "enabled": true
    6         }
    7       },
    8       "experimental": false,
    9       "insecure-registries": [
   10         "repository.dev.eris.go.kr"
   11       ]
   12     }

      중요: 위 예시는 일반적인 설정이 포함된 경우입니다. 님의 설정 파일에 이미 내용이 있다면,
  insecure-registries 배열만 추가하고 JSON 형식이 깨지지 않도록 주의해주세요. 예를 들어, 마지막 항목 뒤에는
  쉼표가 없어야 합니다.


   4. 오른쪽 아래의 Apply & Restart 버튼을 누릅니다. Docker Desktop이 재시작될 것입니다.

  Docker가 재시작된 후, 터미널을 열고 이전에 실패했던 docker push 명령을 다시 실행해 보세요.



   1 docker push repository.dev.eris.go.kr/jaegertracing/jaeger-operator:1.65.0



  이제 인증서 검증을 건너뛰기 때문에 정상적으로 Push가 진행될 것입니다.
