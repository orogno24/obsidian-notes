##### 1. ArgoCD Rollouts 설치

##### 2. gitOps 레지스트리에 Rollout, Service yaml 파일 작성

##### 3. ArgoCD UI에서 동기화

##### 4. 카나리 배포 확인

배포 유형 검증

롤링 업데이트: maxSurge나 maxUnavailable을 조절해도 readinessProbe 등을 설정하지 않으면 롤링 업데이트 시 잠깐의 Connection refused 발생

Blue-Green 배포: 구버전에서 신버전으로 요청 이동 시, 잠깐의 시간 동안 500 에러 발생. Blue-Green 배포 특성상 해결 방법이 따로 없음

Canary 배포: Rollouts, Service yaml파일을 잘 작성하면 무중단 배포 구현 가능

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: app-fe
  namespace: test-dev
spec:
  replicas: 4
  selector:
    matchLabels:
      app: app-fe
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 0
      steps:
        - setWeight: 20
        - pause: {}
        - setWeight: 40
        - pause: { duration: 20 }
        - setWeight: 60
        - pause: { duration: 20 }
        - setWeight: 80
        - pause: { duration: 20 }
  minReadySeconds: 30
```

## Kong + Kubernetes Service 포트 정리

> **Kong Ingress가 Service `port`를 “Pod 실제 포트”라고 믿고 직접 연결**하기 때문에,  
> Kong 경로를 타는 서비스는 **`Service.port` = `spec.template.containers[*].containerPort`** 를 맞추는 것이 중요

|구분|동작 방식|결과|
|---|---|---|
|**Kong 경유**(L7 프록시가 **Service 포트**로 바로 연결)|사용자 → Kong → `Service.clusterIP:port` → **PodIP:`port`**|포트가 다르면 **ECONNREFUSED / delayed connect error**|
|**Kong 미경유**(내부 또는 ClusterIP 직접 호출)|kube‑proxy가 `targetPort`로 NAT|`port ≠ targetPort` 여도 정상|

## 🔄 Argo Rollouts 무중단 배포 가이드

### 1. 설치

```bash
# 1‑1) 네임스페이스 생성
kubectl create namespace argo-rollouts

# 1‑2) CRD + 컨트롤러 배포
kubectl apply -n argo-rollouts \
  -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml

# 1‑3) kubectl 플러그인 설치
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
sudo install -o root -g root -m 0755 kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

# 1‑4) 정상 설치 확인
kubectl argo rollouts version
```

---

### 2. GitOps 흐름 (Argo CD)

1. **레포 디렉터리 구조 예시**
    
    ```
    k8s/
      frontend/
        rollout.yaml   # Canary 전략 정의
        service.yaml   # port == containerPort
      backend/
        …
    ```
    
2. **Argo CD 애플리케이션 등록**  
    _Path_ = `k8s/frontend`, _Namespace_ = `test-dev`.
    
3. **UI ‘Sync’ 버튼** → 일정 시간 이후 promote-full 클릭
    
4. **배포 관찰**
    
    ```bash
    kubectl argo rollouts get rollout app-fe -n test-dev -w
    ```
    
    _setWeight 20→40→60…_ 단계·파드 상태·트래픽 비율 실시간 확인.

---

카나리 무중단 배포 예시:

Rollout yaml 파일:
```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: app-fe
  namespace: test-dev
spec:
  replicas: 4
  selector:
    matchLabels:
      app: app-fe
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 0
      steps:
        - setWeight: 20
        - pause: {}
        - setWeight: 40
        - pause: { duration: 20 }
        - setWeight: 60
        - pause: { duration: 20 }
        - setWeight: 80
        - pause: { duration: 20 }
  minReadySeconds: 30
  revisionHistoryLimit: 2
  template:
    metadata:
      labels:
        app: app-fe
    spec:
      imagePullSecrets:
        - name: harbor-secret
      containers:
        - name: app-fe
          image: cicd.harbor.dev.eris.go.kr/test-app/front:0.0.16
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: JAEGER_AGENT_HOST
              value: "localhost"
            - name: JAEGER_AGENT_PORT
              value: "6831"
        - name: jaeger-agent
          image: jaegertracing/jaeger-agent:latest
          args:
            - "--reporter.grpc.host-port=jaeger-prod-collector.observability:14250"
            - "--reporter.type=grpc"
          ports:
            - containerPort: 5775
              protocol: UDP
            - containerPort: 6831
              protocol: UDP
            - containerPort: 6832
              protocol: UDP
            - containerPort: 5778
              protocol: TCP
```

Service yaml 파일:
```
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: test-dev
spec:
  selector:
    app: app-fe
  ports:
    - name: http
      port: 8080
      targetPort: 8080
```