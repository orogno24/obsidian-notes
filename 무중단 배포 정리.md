##### 1. ArgoCD Rollouts ì„¤ì¹˜

##### 2. gitOps ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— Rollout, Service yaml íŒŒì¼ ì‘ì„±

##### 3. ArgoCD UIì—ì„œ ë™ê¸°í™”

##### 4. ì¹´ë‚˜ë¦¬ ë°°í¬ í™•ì¸

ë°°í¬ ìœ í˜• ê²€ì¦

ë¡¤ë§ ì—…ë°ì´íŠ¸: maxSurgeë‚˜ maxUnavailableì„ ì¡°ì ˆí•´ë„ readinessProbe ë“±ì„ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ë¡¤ë§ ì—…ë°ì´íŠ¸ ì‹œ ì ê¹ì˜ Connection refused ë°œìƒ

Blue-Green ë°°í¬: êµ¬ë²„ì „ì—ì„œ ì‹ ë²„ì „ìœ¼ë¡œ ìš”ì²­ ì´ë™ ì‹œ, ì ê¹ì˜ ì‹œê°„ ë™ì•ˆ 500 ì—ëŸ¬ ë°œìƒ. Blue-Green ë°°í¬ íŠ¹ì„±ìƒ í•´ê²° ë°©ë²•ì´ ë”°ë¡œ ì—†ìŒ

Canary ë°°í¬: Rollouts, Service yamlíŒŒì¼ì„ ì˜ ì‘ì„±í•˜ë©´ ë¬´ì¤‘ë‹¨ ë°°í¬ êµ¬í˜„ ê°€ëŠ¥

```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
Â  name: app-fe
Â  namespace: test-dev
spec:
Â  replicas: 4
Â  selector:
Â  Â  matchLabels:
Â  Â  Â  app: app-fe
Â  strategy:
Â  Â  canary:
Â  Â  Â  maxSurge: 1
Â  Â  Â  maxUnavailable: 0
Â  Â  Â  steps:
Â  Â  Â  Â  - setWeight: 20
Â  Â  Â  Â  - pause: {}
Â  Â  Â  Â  - setWeight: 40
Â  Â  Â  Â  - pause: { duration: 20 }
Â  Â  Â  Â  - setWeight: 60
Â  Â  Â  Â  - pause: { duration: 20 }
Â  Â  Â  Â  - setWeight: 80
Â  Â  Â  Â  - pause: { duration: 20 }
Â  minReadySeconds: 30
```

## KongÂ +Â KubernetesÂ ServiceÂ í¬íŠ¸ ì •ë¦¬

> **Kongâ€¯Ingressê°€ Serviceâ€¯`port`ë¥¼ â€œPodâ€¯ì‹¤ì œ í¬íŠ¸â€ë¼ê³  ë¯¿ê³  ì§ì ‘ ì—°ê²°**í•˜ê¸° ë•Œë¬¸ì—,  
> Kongâ€¯ê²½ë¡œë¥¼ íƒ€ëŠ” ì„œë¹„ìŠ¤ëŠ” **`Service.port`Â =Â `spec.template.containers[*].containerPort`**â€¯ë¥¼ ë§ì¶”ëŠ” ê²ƒì´ ì¤‘ìš”

|êµ¬ë¶„|ë™ì‘ ë°©ì‹|ê²°ê³¼|
|---|---|---|
|**Kong ê²½ìœ **(L7 í”„ë¡ì‹œê°€ **Service í¬íŠ¸**ë¡œ ë°”ë¡œ ì—°ê²°)|ì‚¬ìš©ì â†’ Kong â†’ `Service.clusterIP:port` â†’ **PodIP:`port`**|í¬íŠ¸ê°€ ë‹¤ë¥´ë©´ **ECONNREFUSED / delayed connect error**|
|**Kong ë¯¸ê²½ìœ **(ë‚´ë¶€ ë˜ëŠ” ClusterIP ì§ì ‘ í˜¸ì¶œ)|kubeâ€‘proxyê°€ `targetPort`ë¡œ NAT|`port â‰  targetPort` ì—¬ë„ ì •ìƒ|

## ğŸ”„Â ArgoÂ Rollouts ë¬´ì¤‘ë‹¨ ë°°í¬Â ê°€ì´ë“œ

### 1.Â ì„¤ì¹˜

```bash
# 1â€‘1) ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
kubectl create namespace argo-rollouts

# 1â€‘2) CRD + ì»¨íŠ¸ë¡¤ëŸ¬ ë°°í¬
kubectl apply -n argo-rollouts \
  -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml

# 1â€‘3) kubectl í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
sudo install -o root -g root -m 0755 kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

# 1â€‘4) ì •ìƒ ì„¤ì¹˜ í™•ì¸
kubectl argo rollouts version
```

---

### 2.Â GitOps íë¦„ (ArgoÂ CD)

1. **ë ˆí¬ ë””ë ‰í„°ë¦¬ êµ¬ì¡° ì˜ˆì‹œ**
    
    ```
    k8s/
      frontend/
        rollout.yaml   # Canary ì „ëµ ì •ì˜
        service.yaml   # port == containerPort
      backend/
        â€¦
    ```
    
2. **ArgoÂ CD ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡**  
    _Path_Â =Â `k8s/frontend`, _Namespace_Â =Â `test-dev`.
    
3. **UI â€˜Syncâ€™ ë²„íŠ¼**Â â†’Â ì¼ì • ì‹œê°„ ì´í›„ promote-full í´ë¦­
    
4. **ë°°í¬ ê´€ì°°**
    
    ```bash
    kubectl argo rollouts get rollout app-fe -n test-dev -w
    ```
    
    _setWeightÂ 20â†’40â†’60â€¦_ ë‹¨ê³„Â·íŒŒë“œ ìƒíƒœÂ·íŠ¸ë˜í”½ ë¹„ìœ¨ ì‹¤ì‹œê°„ í™•ì¸.

---

ì¹´ë‚˜ë¦¬ ë¬´ì¤‘ë‹¨ ë°°í¬ ì˜ˆì‹œ:

Rollout yaml íŒŒì¼:
```
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: app-fe
  namespace: test-dev
spec:
  replicas: 4
  selector:
    matchLabels:
      app: app-fe
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 0
      steps:
        - setWeight: 20
        - pause: {}
        - setWeight: 40
        - pause: { duration: 20 }
        - setWeight: 60
        - pause: { duration: 20 }
        - setWeight: 80
        - pause: { duration: 20 }
  minReadySeconds: 30
  revisionHistoryLimit: 2
  template:
    metadata:
      labels:
        app: app-fe
    spec:
      imagePullSecrets:
        - name: harbor-secret
      containers:
        - name: app-fe
          image: cicd.harbor.dev.eris.go.kr/test-app/front:0.0.16
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: JAEGER_AGENT_HOST
              value: "localhost"
            - name: JAEGER_AGENT_PORT
              value: "6831"
        - name: jaeger-agent
          image: jaegertracing/jaeger-agent:latest
          args:
            - "--reporter.grpc.host-port=jaeger-prod-collector.observability:14250"
            - "--reporter.type=grpc"
          ports:
            - containerPort: 5775
              protocol: UDP
            - containerPort: 6831
              protocol: UDP
            - containerPort: 6832
              protocol: UDP
            - containerPort: 5778
              protocol: TCP
```

Service yaml íŒŒì¼:
```
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: test-dev
spec:
  selector:
    app: app-fe
  ports:
    - name: http
      port: 8080
      targetPort: 8080
```