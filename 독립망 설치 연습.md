
ì•„ë˜ ë‹¨ê³„ë“¤ì€ â€œë§ ê°œí†µ ì „ê¹Œì§€ ë…ë¦½ë§ ì„¤ì¹˜ ì—°ìŠµâ€ì´ë¼ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê°€ì •í•˜ê³ ,  
**â‘  ì‹¤-ì„œë¹„ìŠ¤ í´ëŸ¬ìŠ¤í„°(online) â†’ â‘¡ ê°€ìƒ í´ëŸ¬ìŠ¤í„°(VirtualBox, offline)** ë¡œ Nexus Repositoryì™€ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ì˜®ê¸´ ë’¤, PC ì¸í„°ë„·ì„ ì„ ë½‘ì€ ìƒíƒœì—ì„œë„ ì¿ ë²„ë„¤í‹°ìŠ¤Â·ì˜¤í”ˆì†ŒìŠ¤ë¥¼ ì„¤ì¹˜-ë°°í¬í•  ìˆ˜ ìˆê²Œ ë§Œë“œëŠ” ì „ì²´ íë¦„ì…ë‹ˆë‹¤.

---

## 1 ë‹¨ê³„â€†â€•â€†ì˜¨ë¼ì¸ Nexusì— í•„ìš”í•œ ì´ë¯¸ì§€ í‘¸ì‹œ

1. **í•„ìš” ì´ë¯¸ì§€ ëª©ë¡ ì‚°ì¶œ**
    
    ```bash
    # ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì´ë¯¸ì§€ ëª©ë¡ â†’ ì¤‘ë³µ ì œê±°
    kubectl get pods -A \
      -o jsonpath='{..image}' | \
      tr -s '[[:space:]]' '\n' | sort -u > images.txt
    ```
    
    _ì¶”ê°€ë¡œ Helm ì°¨íŠ¸, apt/yum íŒ¨í‚¤ì§€, íŒŒì´ì¬ wheel ë“± ì˜¤í”„ë¼ì¸ì—ì„œ ì“¸ ì•„í‹°íŒ©íŠ¸ë¥¼ ì „ë¶€ ì •ë¦¬í•´ ë‘¡ë‹ˆë‹¤._
    
2. **ì´ë¯¸ì§€ ì‚¬ì „ í’€(Pull) â†’ Nexusë¡œ íƒœê¹…(Tag) â†’ í‘¸ì‹œ(Push)**
    
    ```bash
    REG=repository.dev.eris.go.kr:443/docker
    
    while read IMG; do
      docker pull "$IMG"
      NEW=${IMG#*/}                     # ex) nginx:1.25
      docker tag "$IMG" "$REG/$NEW"
      docker push "$REG/$NEW"
    done < images.txt
    ```
    
3. **Nexus ë¦¬í¬ì§€í† ë¦¬ êµ¬ì¡° ì˜ˆì‹œ**
    
    |íƒ€ì…|í˜¸ìŠ¤íŠ¸ ì˜ˆì‹œ|ì„¤ëª…|
    |---|---|---|
    |docker-proxy|docker.io ë¯¸ëŸ¬|ê³µì‹ ì´ë¯¸ì§€ ìºì‹œìš©|
    |docker-hosted|docker private|ì‚¬ë‚´ ì „ìš© ì´ë¯¸ì§€|
    |helm-hosted|helm-chart|`.tgz` ì°¨íŠ¸ ì €ì¥|
    |raw-hosted|apt, yum, ê¸°íƒ€|`.deb`, `.rpm`, ì••ì¶• íŒŒì¼ ë“±|
    

---

## 2 ë‹¨ê³„â€†â€•â€†Nexus PV ë°±ì—… (Export)

> **ì›ë¦¬**  
> Nexus 3ëŠ” â€˜blob storeâ€™(ë°”ì´ë„ˆë¦¬) + â€˜OrientDB/H2 DBâ€™(ë©”íƒ€ë°ì´í„°)ë¥¼ ê°™ì´ ë°±ì—…í•´ì•¼ í•¨ ([help.sonatype.com](https://help.sonatype.com/en/prepare-a-backup.html?utm_source=chatgpt.com "Prepare a Backup - Sonatype Help"))

### 2-1. Nexus ì¼ì‹œ ì¤‘ë‹¨

```bash
kubectl scale deploy nexus-nexus-repository-manager -n cicd --replicas=0
```

### 2-2. PV ê²½ë¡œ í™•ì¸

```bash
kubectl get pvc -n cicd | grep nexus
kubectl describe pvc <PVC_NAME> -n cicd  # PVÂ·StorageClassÂ·ë…¸ë“œ ê²½ë¡œ í™•ì¸
```

### 2-3. PV ë‚´ìš©ì„ tar ë¡œ ë¬¶ê¸° (K8s Job)

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: nexus-backup
  namespace: cicd
spec:
  template:
    spec:
      containers:
      - name: backup
        image: alpine:3
        command: ["sh","-c","tar czf /backup/nexus-data.tgz -C /nexus-data ."]
        volumeMounts:
        - name: nexus-data
          mountPath: /nexus-data         # nexus chartì˜ mountPath
        - name: backup
          mountPath: /backup
      restartPolicy: Never
      volumes:
      - name: nexus-data
        persistentVolumeClaim:
          claimName: <PVC_NAME>
      - name: backup
        hostPath:                        # â˜… í˜¸ìŠ¤íŠ¸ ê²½ë¡œë¡œ ë³µì‚¬í•˜ê¸° ì‰¬ìš´ ê³³ ì§€ì •
          path: /tmp
---
```

```bash
kubectl apply -f job-backup.yaml
kubectl logs job/nexus-backup -n cicd -f      # ì™„ë£Œ í™•ì¸
```

### 2-4. tar íŒŒì¼ ê°€ì ¸ì˜¤ê¸°

```bash
scp k8s-node:/tmp/nexus-data.tgz .
```

---

## 3 ë‹¨ê³„â€†â€•â€†VirtualBox í´ëŸ¬ìŠ¤í„°ì— Nexus ë³µì› (Import)

### 3-1. ê°€ìƒ í´ëŸ¬ìŠ¤í„° PV ì¤€ë¹„

- ê°€ìƒ ë…¸ë“œ(ì˜ˆ: master-vm)ì— `/opt/nexus-data` ë””ë ‰í„°ë¦¬ ìƒì„± í›„ tar ì••ì¶• í•´ì œ
    
    ```bash
    mkdir -p /opt/nexus-data && tar xzf nexus-data.tgz -C /opt/nexus-data
    chown -R 200:200 /opt/nexus-data         # nexus UID/GID(200) ë§ì¶¤
    ```
    
- **hostPath PV** ë§¤ë‹ˆí˜ìŠ¤íŠ¸
    
    ```yaml
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: pv-nexus
    spec:
      capacity:
        storage: 20Gi
      accessModes: ["ReadWriteOnce"]
      hostPath:
        path: /opt/nexus-data
      persistentVolumeReclaimPolicy: Retain
    ```
    

### 3-2. Nexus ì„¤ì¹˜ (Helm ì°¨íŠ¸)

```bash
helm repo add oteemo https://oteemo.github.io/charts
helm upgrade --install nexus oteemo/sonatype-nexus \
  --namespace cicd --create-namespace \
  -f values.yaml \
  --set persistence.enabled=true \
  --set persistence.existingClaim=pvc-nexus \
  --set ingress.enabled=true \
  --set ingress.hosts={nexus.offline.local}
```

_values.yaml_ ì˜ˆì‹œ(í•„ìˆ˜ ìˆ˜ì •)

```yaml
nexus:
  nexusSecurityContext:
    runAsUser: 200
    fsGroup: 200
  env:
    - name: INSTALL4J_ADD_VM_PARAMS
      value: >
        -Xms256m -Xmx2g
  resources:
    limits:
      memory: 4Gi
```

> Helm ì°¨íŠ¸(oteemo) 2.3.1 ì´ìƒì€ ì™¸ë¶€ DB ë°±ì—…/ë³µì› ì‹œ blobPath, dbPath ìˆ˜ë™ì§€ì •ì´ ê°€ëŠ¥ ([artifacthub.io](https://artifacthub.io/packages/helm/oteemo-charts/sonatype-nexus/2.3.1?utm_source=chatgpt.com "sonatype-nexus - Oteemo Charts - Artifact Hub"))

---

## 4 ë‹¨ê³„â€†â€•â€†ì˜¤í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (PC ì¸í„°ë„·ì„  ì œê±°)

1. **/etc/hosts** ìˆ˜ì • (ê°œë°œ PC ë° ë…¸ë“œ)
    
    ```
    192.168.56.10   nexus.offline.local
    ```
    
2. **ImagePullSecret** ìƒì„±
    
    ```bash
    kubectl create secret docker-registry nexus-auth \
      --docker-server=nexus.offline.local:443 \
      --docker-username=<id> --docker-password=<pw> \
      -n <target-namespace>
    ```
    
3. **ìƒ˜í”Œ ë°°í¬**
    
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: nginx
    spec:
      replicas: 1
      selector:
        matchLabels: {app: nginx}
      template:
        metadata: {labels: {app: nginx}}
        spec:
          imagePullSecrets:
          - name: nexus-auth
          containers:
          - name: nginx
            image: nexus.offline.local:443/docker/nginx:1.25
    ```
    
4. **Helm ì°¨íŠ¸/íŒ¨í‚¤ì§€ ì„¤ì¹˜**
    
    - `helm repo add internal https://nexus.offline.local/repository/helm-hosted`
        
    - `helm install myprom prom/prometheus -f values.yaml --repo internal`
        

---

## 5 ë‹¨ê³„â€†â€•â€†ìš´ì˜ íŒ & ì²´í¬ë¦¬ìŠ¤íŠ¸

|ì²´í¬|ì„¤ëª…|
|---|---|
|ğŸ¯ Blob store ê²½ë¡œ í™•ì¸|ë³µì› ì‹œ `nexus-data/blobs` ê²½ë¡œ ë¬´ê²°ì„± í•„ìˆ˜|
|ğŸ¯ ë¼ì´ì„¼ìŠ¤/í”„ë¡œ ê¸°ëŠ¥|Nexus Pro ì „ìš© REST export/import íƒœìŠ¤í¬ëŠ” Pro ë¼ì´ì„¼ìŠ¤ í•„ìš” ([help.sonatype.com](https://help.sonatype.com/en/repository-import.html?utm_source=chatgpt.com "Repository Import - Sonatype Help"))|
|ğŸ¯ Cron ë°±ì—…|ê°€ìƒ í´ëŸ¬ìŠ¤í„°ì—ë„ ì£¼ê¸°ì  tar ë°±ì—…(ì˜ˆ: Velero RESTIC)ì„ ê±¸ì–´ ë‘˜ ê²ƒ|
|ğŸ¯ ë¦¬í¬ì§€í† ë¦¬ ìºì‹œ|docker-proxyÂ·maven-proxy ë“±ì€ offline ëª¨ë“œì—ì„œ `offline=true` ì„¤ì •|
|ğŸ¯ DNS ìºì‹œ|ì¸í„°ë„· ë¶„ë¦¬ í›„ì—ë„ ë‚´ë¶€ FQDN í•´ê²°ë˜ë„ë¡ CoreDNS ConfigMapì— stubDomain ì¶”ê°€|

---

### í•œ ì¤„ ì •ë¦¬

> **â€œì˜¨ë¼ì¸ Nexusì—ì„œ ì´ë¯¸ì§€/ë°ì´í„°ë¥¼ tarë¡œ ë°±ì—… â†’ VirtualBox í´ëŸ¬ìŠ¤í„°ì— hostPath PVë¡œ ë³µì› â†’ ë‚´ë¶€ DNS/Secret ì„¤ì • í›„ ì¸í„°ë„·ì„  ì œê±°â€**  
> ì´ ìˆœì„œëŒ€ë¡œë©´ ì™„ì „íˆ ì°¨ë‹¨ëœ ë§ì—ì„œë„ ì¿ ë²„ë„¤í‹°ìŠ¤ ë°°í¬ì™€ ì˜¤í”ˆì†ŒìŠ¤ ì„¤ì¹˜ê°€ ë¬¸ì œì—†ì´ ë™ì‘í•©ë‹ˆë‹¤. í•„ìš”-ìŠ¤í¬ë¦½íŠ¸ì™€ values.yamlë§Œ ë§ì¶¤-ìˆ˜ì •í•´ ë³´ì„¸ìš”!

| ë‹¨ê³„                  | í•µì‹¬ í•œë§ˆë””                                            | ì™œ í•˜ëŠ”ì§€                       | ì†ì‰½ê²Œ í•˜ëŠ” ìš”ë ¹                                                                                                                                |
| ------------------- | ------------------------------------------------- | --------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **1. ì´ë¯¸ì§€ ëª¨ìœ¼ê¸°**      | **â€œí•„ìš”í•œ ì»¨í…Œì´ë„ˆ ì „ë¶€ â†’ ì‚¬ë‚´ Nexusë¡œ Pushâ€**                | ì¸í„°ë„·ì´ ëŠê¸°ë©´ Docker Hubì— ì ‘ì† ëª» í•¨ | ```bash# â‘  í´ëŸ¬ìŠ¤í„°ì—ì„œ ì“°ëŠ” ì´ë¯¸ì§€ ëª©ë¡ ë½‘ê¸°k get pods -A -o jsonpath='{..image}'                                                                      |
| **2. Nexus ë°ì´í„° ë°±ì—…** | **â€œ/nexus-data í´ë”ë¥¼ tar.gzë¡œ ì••ì¶•â€**                  | ì´ë¯¸ì§€ë¥¼ ë‹´ì€ ì €ì¥ì†Œ(ë¸”ë¡­)ê³¼ DBë¥¼ í†µì§¸ë¡œ ë¹¼ëƒ„ | ì¿ ë²„ë„¤í‹°ìŠ¤ Job í•˜ë‚˜ë¡œ: `tar czf /backup/nexus.tgz -C /nexus-data .`                                                                              |
| **3. ê°€ìƒ í´ëŸ¬ìŠ¤í„°ì— ë³µì›**  | **â€œVirtualBox â˜ /opt/nexus-data ì— ì••ì¶• í’€ê³  ë‹¤ì‹œ ë„ìš°ê¸°â€** | ì˜¤í”„ë¼ì¸ì—ì„œë„ ë˜‘ê°™ì€ Nexusê°€ í•„ìš”       | `bash<br>mkdir -p /opt/nexus-data<br>tar xzf nexus.tgz -C /opt/nexus-data<br>helm install nexus ... --set persistence.existingClaim=...` |
| **4. ì¸í„°ë„·ì„  ë½‘ê³  í…ŒìŠ¤íŠ¸**  | **â€œ/etc/hosts + ImagePullSecret ì„¤ì • í›„ ë°°í¬ê°€ ë„ë‚˜?â€**   | ì™„ì „ ì°¨ë‹¨ ìƒíƒœì—ì„œë„ ë°°í¬/ì—…ë°ì´íŠ¸ ê²€ì¦      | * hosts íŒŒì¼ì— `nexus.offline.local` ì¶”ê°€* ë°°í¬ YAML ì— `image: nexus.offline.local:443/docker/nginx:1.25`                                       |

---

#### 10ì´ˆ ìš”ì•½

1ï¸âƒ£ **ì´ë¯¸ì§€/íŒ¨í‚¤ì§€ ë‹¤ ëª¨ì•„ì„œ** ì‚¬ë‚´ Nexusì— ë„£ê³  â†’  
2ï¸âƒ£ **Nexus í´ë”ë¥¼ tar ë¡œ ë°±ì—…** â†’  
3ï¸âƒ£ **VirtualBox í´ëŸ¬ìŠ¤í„°ì— ê·¸ëŒ€ë¡œ í’€ì–´** Nexus ì¬ê°€ë™ â†’  
4ï¸âƒ£ **ì¸í„°ë„· ëŠê³ ** ì´ë¯¸ì§€ê°€ ì˜ PullÂ·ë°°í¬ë˜ë©´ ì„±ê³µ!

ì´ ë„¤ ê°€ì§€ë§Œ ê¸°ì–µí•˜ë©´ ì‹¤ë¬´ ë§ ë¶„ë¦¬ í™˜ê²½ë„ ê¸ˆë°© êµ¬ì¶•í•  ìˆ˜ ìˆì–´ìš”. ğŸš€