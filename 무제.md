eris/sts-svc

FROM nexus-nexus-repository-manager:9900/tomcat:9.0-jdk8

# OpenJDK 17 설치
COPY ./openjdk-17.0.2_linux-x64_bin.tar.gz /tmp/

RUN mkdir -p /usr/lib/jvm && \
    cd /tmp && \
    tar -xf openjdk-17.0.2_linux-x64_bin.tar.gz -C /usr/lib/jvm && \
    rm openjdk-17.0.2_linux-x64_bin.tar.gz
ENV JAVA_HOME=/usr/lib/jvm/jdk-17.0.2
ENV PATH=$JAVA_HOME/bin:$PATH

# PostgreSQL JDBC 드라이버 복사
COPY ./postgresql-42.7.6.jar /usr/local/tomcat/lib/

# DataServer 애플리케이션 복사
RUN mkdir -p /data
COPY ./DataServer /data/DataServer
COPY ./ReportingServer /data/ReportingServer

# 포트 노출
EXPOSE 8080

# Tomcat 실행
CMD ["catalina.sh", "run"]

deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: eris-be-sts
  name: eris-be-sts
  namespace: eris-be
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eris-be-sts
  template:
    metadata:
      labels:
        app: eris-be-sts
    spec:
      containers:
      - name: eris-be-sts
        image: cicd.harbor.dev.eris.go.kr/eris/sts-svc:1.0.3
        ports:
          - containerPort: 8080
        volumeMounts:
          - name: webapps
            mountPath: /usr/local/tomcat/webapps
      initContainers:
      - name: eris-be-sts-copy
        image: cicd.harbor.dev.eris.go.kr/eris/sts-svc:1.0.3
        volumeMounts:
          - name: webapps
            mountPath: /usr/local/tomcat/webapps
        command:
          - sh
          - -c          
          - 'cp -r /data/* /usr/local/tomcat/webapps/'
      volumes:
        - name: webapps
          persistentVolumeClaim:
            claimName: eris-be-sts-pvc


https://gitea.dev.eris.go.kr/eris/sts-svc

├── .idea/
│   └── libraries/         # IDE 설정 관련 (예: IntelliJ)
├── DataServer/            # 서버 구성 요소 (설정 변경 커밋 있음)
├── ReportingServer/       # 보고서 관련 서버 (설정 변경 커밋 있음)
├── docs/                  # 문서 관련 초기화
├── Dockerfile             # 도커 설정 파일
├── openjdk-17.0.2_linux-x64_bin.tar.gz  # JDK 바이너리 추가됨
├── postgresql-42.7.6.jar  # JDBC 드라이버
└── README.md              # 프로젝트 소개 문서

crownix.groovy 파이프라인

def checkout() {
    stage('Git Checkout') {
        try {
            echo("===============[Git Checkout] 단계 시작===============")
            
            git (
                url: env.GIT_URL, 
                branch: env.GIT_BRANCH, 
                credentialsId: env.GIT_CREDENTIALS_ID, 
            )

            env.APP_VERSION = params.SELECTED_TAG
            if (params.SELECTED_TAG) {
                def tagExists = sh(
                    script: "git tag -l ${params.SELECTED_TAG}",
                    returnStdout: true
                ).trim()
                
                if (!tagExists) {   

                    echo("선택한 태그 ${params.SELECTED_TAG}가 존재하지 않습니다.")
                    env.APP_VERSION = sh(
                        script: "git tag --sort=-v:refname | head -n 1",
                        returnStdout: true
                    ).trim()
                }
            }
            echo("App Version: ${env.APP_VERSION}")
            sh("git checkout ${env.APP_VERSION}")

            echo("===============[Git Checkout] 단계 종료===============")
        } catch (err) {
            echo("[Git Checkout] 실패: ${err}")
            error("Git 체크아웃 단계에서 오류 발생")
        }
    }
}

def dockerBuild() {
    stage('Docker Build') {
        try {
            echo("===============[Docker Build] 단계 시작===============")

            container('docker-dind') {
                sh("docker build -t ${env.DOCKER_REGISTRY_URL}/${env.DOCKER_IMAGE_NAME}:${env.APP_VERSION} .")
                sh("docker tag ${env.DOCKER_REGISTRY_URL}/${env.DOCKER_IMAGE_NAME}:${env.APP_VERSION} ${env.DOCKER_REGISTRY_URL}/${env.DOCKER_IMAGE_NAME}:latest")
            }

            echo("===============[Docker Build] 단계 종료===============")
        } catch (err) {
            echo("Docker Build 실패: ${err.getMessage()}")
            error("Docker Build 단계에서 오류 발생")
        }
    }
}

def dockerPush() {
    stage('Docker Push') {
        echo("===============[Docker Push] 단계 시작===============")

        container('docker-dind') {
            withCredentials([usernamePassword(
                credentialsId: 'harbor-robot-token',
                usernameVariable: 'HARBOR_USER',
                passwordVariable: 'HARBOR_PASS'
            )]) {
                sh """
                        echo '$HARBOR_PASS' | docker login "${DOCKER_REGISTRY_URL}" -u '$HARBOR_USER' --password-stdin
                        docker push ${DOCKER_REGISTRY_URL}/${DOCKER_IMAGE_NAME}:${APP_VERSION}
                    """
            }
        }

        echo("===============[Docker Push] 단계 종료===============")
    }
}

def gitOpsDeploy() {
    stage('GitOps Deploy') {
        echo("===============[GitOps Deploy] 단계 시작===============")

        git (
            url: env.GITOPS_URL,
            branch: env.GITOPS_BRANCH,
            credentialsId: env.GITOPS_CREDENTIALS_ID
        )

        script {
            dir(env.GITOPS_DIR){
                withCredentials([usernamePassword(credentialsId: env.GITOPS_CREDENTIALS_ID, passwordVariable: 'GITOPS_PASSWORD', usernameVariable: 'GITOPS_USERNAME')]) {

                    def currentVersion = sh(script: "grep 'image:' base/deployment.yaml | awk -F ':' '{print \$NF}' | head -n 1", returnStdout: true).trim()
                    echo("현재 버전: ${currentVersion}")
                    echo("신규 버전: ${env.APP_VERSION}")
                    
                    if (currentVersion != env.APP_VERSION) {
                        echo("버전이 다릅니다. 업데이트를 진행합니다.")
                        sh("""
                                # containers 섹션의 이미지 업데이트
                                sed -i "/name: ${GITOPS_CONTAINER_NAME}/{n;s|image: .*|image: ${DOCKER_IMAGE_URL}:${env.SELECTED_TAG}|}" base/deployment.yaml
                                
                                # initContainers 섹션의 이미지 업데이트
                                sed -i "/name: ${GITOPS_CONTAINER_NAME}-copy/{n;s|image: .*|image: ${DOCKER_IMAGE_URL}:${env.SELECTED_TAG}|}" base/deployment.yaml
                            
                                git config --global user.email "jenkins@okestro.com"
                                git config --global user.name "jenkins"
                                git add base/deployment.yaml
                                git commit -m "Update image version: ${env.SELECTED_TAG}"
                                git push http://${GITOPS_USERNAME}:${GITOPS_PASSWORD}@${GITOPS_PATH} ${GITOPS_BRANCH}
                            """)                                        
                    } else {
                        echo("버전이 동일합니다. 업데이트가 필요하지 않습니다.")
                    }
                }
            }
        }
        echo("===============[GitOps Deploy] 단계 종료===============")
    }
}

return this

통계서비스 레포지토리와 파이프라인 사용해서 파일 수정할 수있도록 수정  
통계서비스만 파일과 파이프라인이 다름  
crownix.groovy와 rollback-cronwix.groovy 사용  
pvc, ingress 사용

요구사항: https://gitea.dev.eris.go.kr/eris/sts-svc에서 [ReportingServer] 디렉터리를 제외하고 gitea repo에서 보이지 않도록 하고싶음