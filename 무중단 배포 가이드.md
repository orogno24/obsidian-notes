
ë¬´ì¤‘ë‹¨ ë°°í¬ëŠ” ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ ìƒˆë¡œìš´ ë²„ì „ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤. ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œí‚¤ê³  ë¹„ì¦ˆë‹ˆìŠ¤ ì—°ì†ì„±ì„ ë³´ì¥í•˜ëŠ” ì¤‘ìš”í•œ DevOps ì‹¤ì²œ ë°©ë²•ì…ë‹ˆë‹¤.
### ë¬´ì¤‘ë‹¨ ë°°í¬ì˜ í•µì‹¬ ì›ì¹™
- **ì„œë¹„ìŠ¤ ê°€ìš©ì„± ìœ ì§€**: ë°°í¬ ì¤‘ì—ë„ ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘
- **ì ì§„ì  ì „í™˜**: íŠ¸ë˜í”½ì„ ì ì§„ì ìœ¼ë¡œ ìƒˆ ë²„ì „ìœ¼ë¡œ ì „í™˜
- **ë¡¤ë°± ê°€ëŠ¥ì„±**: ë¬¸ì œ ë°œìƒ ì‹œ ì¦‰ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬
- **ëª¨ë‹ˆí„°ë§**: ë°°í¬ ê³¼ì •ì—ì„œ ì§€ì†ì ì¸ ìƒíƒœ ëª¨ë‹ˆí„°ë§

---

## ë°°í¬ ì „ëµ ë¹„êµ

### 1. ë¡¤ë§ ì—…ë°ì´íŠ¸ (Rolling Update)
**íŠ¹ì§•**: ê¸°ì¡´ íŒŒë“œë¥¼ í•˜ë‚˜ì”© ìƒˆ ë²„ì „ìœ¼ë¡œ êµì²´

**ì¥ì **:
- ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì  (ì¶”ê°€ ë¦¬ì†ŒìŠ¤ ìµœì†Œí™”)
- ê°„ë‹¨í•œ êµ¬í˜„

**ë‹¨ì **:
- `readinessProbe` ì„¤ì •ì´ ì¤‘ìš”
- ì¼ì‹œì ì¸ ì—°ê²° ê±°ë¶€ ê°€ëŠ¥ì„±
- ë¡¤ë°± ì‹œ ì „ì²´ ì¬ë°°í¬ í•„ìš”

**ì ìš© ì‹œë‚˜ë¦¬ì˜¤**: 
- ë‹¨ìˆœí•œ ì• í”Œë¦¬ì¼€ì´ì…˜
- ë¦¬ì†ŒìŠ¤ ì œì•½ í™˜ê²½
- ë¹ ë¥¸ ë°°í¬ê°€ í•„ìš”í•œ ê²½ìš°

### 2. ë¸”ë£¨-ê·¸ë¦° ë°°í¬ (Blue-Green Deployment)
**íŠ¹ì§•**: ì™„ì „íˆ ìƒˆë¡œìš´ í™˜ê²½ì„ êµ¬ì¶• í›„ íŠ¸ë˜í”½ ì „í™˜

**ì¥ì **:
- ë¹ ë¥¸ ë¡¤ë°± (DNS/ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì •ë§Œ ë³€ê²½)
- ì™„ì „í•œ í™˜ê²½ ê²©ë¦¬
- í…ŒìŠ¤íŠ¸ í™˜ê²½ìœ¼ë¡œ í™œìš© ê°€ëŠ¥

**ë‹¨ì **:
- ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ 2ë°°
- ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë³µì¡ì„±
- ì „í™˜ ì‹œ ì¼ì‹œì  500 ì—ëŸ¬ ë°œìƒ

**ì ìš© ì‹œë‚˜ë¦¬ì˜¤**:
- ì¤‘ìš” ì—…ë¬´ ì‹œìŠ¤í…œ
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ ìˆëŠ” ê²½ìš°
- ì™„ì „í•œ ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš°

### 3. ì¹´ë‚˜ë¦¬ ë°°í¬ (Canary Deployment)
**íŠ¹ì§•**: íŠ¸ë˜í”½ì„ ì ì§„ì ìœ¼ë¡œ ìƒˆ ë²„ì „ìœ¼ë¡œ ì „í™˜

**ì¥ì **:
- ìœ„í—˜ ìµœì†Œí™”
- ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥
- ì„¸ë°€í•œ íŠ¸ë˜í”½ ì œì–´

**ë‹¨ì **:
- ë³µì¡í•œ ì„¤ì •
- ëª¨ë‹ˆí„°ë§ ì¸í”„ë¼ í•„ìš”
- ì¥ê¸°ê°„ ë°°í¬ ê³¼ì •

**ì ìš© ì‹œë‚˜ë¦¬ì˜¤**:
- ëŒ€ê·œëª¨ ì‚¬ìš©ì ê¸°ë°˜
- ì•ˆì •ì„±ì´ ì¤‘ìš”í•œ ì„œë¹„ìŠ¤
- A/B í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•œ ê²½ìš°

---

## ArgoCD Rollouts ì„¤ì¹˜

### 1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
```bash
kubectl create namespace argo-rollouts
```

### 2. CRD ë° ì»¨íŠ¸ë¡¤ëŸ¬ ë°°í¬
```bash
kubectl apply -n argo-rollouts \
  -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml
```

### 3. kubectl í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
```bash
# Linux
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
sudo install -o root -g root -m 0755 kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

# macOS
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-darwin-amd64
sudo install -o root -g root -m 0755 kubectl-argo-rollouts-darwin-amd64 /usr/local/bin/kubectl-argo-rollouts

# Windows
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-windows-amd64.exe
# PATHì— ì¶”ê°€í•˜ê±°ë‚˜ ì›í•˜ëŠ” ìœ„ì¹˜ë¡œ ì´ë™
```

### 4. ì„¤ì¹˜ í™•ì¸
```bash
kubectl argo rollouts version
```

---

## GitOps ê¸°ë°˜ ë¬´ì¤‘ë‹¨ ë°°í¬

### GitOps íë¦„
1. **ì½”ë“œ ë³€ê²½** â†’ Git ì €ì¥ì†Œì— í‘¸ì‹œ
2. **CI/CD íŒŒì´í”„ë¼ì¸** â†’ ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ
3. **GitOps ë„êµ¬** â†’ Git ì €ì¥ì†Œì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê°ì§€
4. **ìë™ ë°°í¬** â†’ í´ëŸ¬ìŠ¤í„°ì— ë³€ê²½ì‚¬í•­ ì ìš©
5. **ëª¨ë‹ˆí„°ë§** â†’ ë°°í¬ ìƒíƒœ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ í™•ì¸

---
## ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œ

### 1. ì¹´ë‚˜ë¦¬ ë°°í¬ Rollout ì •ì˜

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: app-fe
  namespace: test-dev
spec:
  replicas: 4
  selector:
    matchLabels:
      app: app-fe
  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 0
      steps:
        - setWeight: 20
        - pause: {}
        - setWeight: 40
        - pause: { duration: 20 }
        - setWeight: 60
        - pause: { duration: 20 }
        - setWeight: 80
        - pause: { duration: 20 }
  minReadySeconds: 30
  revisionHistoryLimit: 2
  template:
    metadata:
      labels:
        app: app-fe
    spec:
      imagePullSecrets:
        - name: harbor-secret
      containers:
        - name: app-fe
          image: cicd.harbor.dev.eris.go.kr/test-app/front:0.0.16
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: JAEGER_AGENT_HOST
              value: "localhost"
            - name: JAEGER_AGENT_PORT
              value: "6831"
        - name: jaeger-agent
          image: jaegertracing/jaeger-agent:latest
          args:
            - "--reporter.grpc.host-port=jaeger-prod-collector.observability:14250"
            - "--reporter.type=grpc"
          ports:
            - containerPort: 5775
              protocol: UDP
            - containerPort: 6831
              protocol: UDP
            - containerPort: 6832
              protocol: UDP
            - containerPort: 5778
              protocol: TCP
```

### 2. Service ì •ì˜

```yaml
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: test-dev
spec:
  selector:
    app: app-fe
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP
```

---
## Kong + Kubernetes Service í¬íŠ¸ ì •ë¦¬

> **ì¤‘ìš”**: Kong Ingressê°€ Service `port`ë¥¼ "Pod ì‹¤ì œ í¬íŠ¸"ë¼ê³  ë¯¿ê³  ì§ì ‘ ì—°ê²°í•˜ê¸° ë•Œë¬¸ì—,  
> Kong ê²½ë¡œë¥¼ íƒ€ëŠ” ì„œë¹„ìŠ¤ëŠ” **`Service.port` = `spec.template.containers[*].containerPort`** ë¥¼ ë§ì¶”ëŠ” ê²ƒì´ ì¤‘ìš”

| êµ¬ë¶„ | ë™ì‘ ë°©ì‹ | ê²°ê³¼ |
|------|-----------|------|
| **Kong ê²½ìœ ** (L7 í”„ë¡ì‹œê°€ **Service í¬íŠ¸**ë¡œ ë°”ë¡œ ì—°ê²°) | ì‚¬ìš©ì â†’ Kong â†’ `Service.clusterIP:port` â†’ **PodIP:`port`** | í¬íŠ¸ê°€ ë‹¤ë¥´ë©´ **ECONNREFUSED / delayed connect error** |
| **Kong ë¯¸ê²½ìœ ** (ë‚´ë¶€ ë˜ëŠ” ClusterIP ì§ì ‘ í˜¸ì¶œ) | kubeâ€‘proxyê°€ `targetPort`ë¡œ NAT | `port â‰  targetPort` ì—¬ë„ ì •ìƒ |

### í¬íŠ¸ ì„¤ì • ëª¨ë²” ì‚¬ë¡€
```yaml
# Pod ì •ì˜
spec:
  containers:
    - name: app
      ports:
        - containerPort: 8080  # ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸

---
# Service ì •ì˜
spec:
  ports:
    - name: http
      port: 8080        # Kongì´ ì—°ê²°í•  í¬íŠ¸
      targetPort: 8080  # Podì˜ ì‹¤ì œ í¬íŠ¸
```

---

> **ì„œë¹„ìŠ¤ í¬íŠ¸ ì´ë¦„(`spec.ports[].name`)ì€ ë°˜ë“œì‹œ Istioê°€ ì§€ì›í•˜ëŠ” í”„ë¡œí† ì½œ ì ‘ë‘ì–´ë¡œ ì‹œì‘í•´ì•¼**  
> í•´ë‹¹ í¬íŠ¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ HTTP/gRPC ë“±ìœ¼ë¡œ ì¸ì‹í•˜ê³  L7 ì •ì±…ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### ğŸ¯ ì´ë¦„ ê·œì¹™ ìš”ì•½

|í¬íŠ¸ ì´ë¦„ (`name:`)|Istio í•´ì„|ì‚¬ìš© ì¡°ê±´|
|---|---|---|
|`http` ë˜ëŠ” `http-xxx`|HTTP/1.1|ì¼ë°˜ ì›¹ ì„œë¹„ìŠ¤|
|`http2`, `grpc`|HTTP/2, gRPC|í”„ë¡ íŠ¸/ë°± ì‚¬ì´ í†µì‹ ì´ gRPCì¸ ê²½ìš°|
|`tcp`, `tls`, `mysql`, `mongo`|TCP ë˜ëŠ” ì‹¤í—˜ì  ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ|TLSë‚˜ DBì—°ê²° ë“±|
|âŒ `web`, `api`, `backend`|ğŸš« í”„ë¡œí† ì½œ ì¸ì‹ ì‹¤íŒ¨ â†’ TCP ì²˜ë¦¬ë¨|í”¼í•´ì•¼ í•¨|

âœ”ï¸â€¯**ì ‘ë‘ì–´ë§Œ ë§ìœ¼ë©´ ììœ ë¡­ê²Œ suffix ë¶™ì—¬ë„ ë©ë‹ˆë‹¤.**

- âœ… `http-fe`, `http2-metrics`, `grpc-auth`
- âŒ `web`, `frontend`, `svc`

---

## ğŸ“Œ ì ìš© ì˜ˆ â€“ ì§€ê¸ˆ ìƒí™© ê¸°ì¤€

ë‹¹ì‹ ì˜ ì„œë¹„ìŠ¤ëŠ” ì¼ë°˜ì ì¸ HTTP ê¸°ë°˜ API ë˜ëŠ” ì •ì  ì›¹ í˜ì´ì§€ ì œê³µì´ê¸° ë•Œë¬¸ì—:

```yaml
ports:
- name: http        # âœ… ì˜¬ë°”ë¥¸ í¬íŠ¸ ì´ë¦„
  port: 8080
  targetPort: 8080
```

ì´ê²Œ **ì •í™•íˆ ë§ëŠ” êµ¬ì„±**ì…ë‹ˆë‹¤.

---

## ğŸš« ì˜ëª»ëœ ì´ë¦„ ì˜ˆ

```yaml
ports:
- name: backend     # âŒ IstioëŠ” ì´ê±¸ TCPë¡œ ì²˜ë¦¬í•¨
  port: 8080
```

ì´ë ‡ê²Œ í•˜ë©´ IstioëŠ” í•´ë‹¹ í¬íŠ¸ë¥¼ TCPë¡œ ì¸ì‹í•˜ê³ ,

- **VirtualServiceì˜ HTTP ë¼ìš°íŒ… ë£°ì´ ì‘ë™í•˜ì§€ ì•Šê±°ë‚˜**
- **canary íŠ¸ë˜í”½ ì „í™˜ì´ ë¬´ì‹œë˜ëŠ” ë¬¸ì œ**ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---
## ë°°í¬ ê´€ë¦¬ ëª…ë ¹ì–´

### 1. ë°°í¬ ìƒíƒœ í™•ì¸
```bash
# ì‹¤ì‹œê°„ ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
kubectl argo rollouts get rollout app-fe -n test-dev -w

# ë°°í¬ íˆìŠ¤í† ë¦¬ í™•ì¸
kubectl argo rollouts history app-fe -n test-dev

# íŠ¹ì • ë¦¬ë¹„ì „ìœ¼ë¡œ ë¡¤ë°±
kubectl argo rollouts undo app-fe -n test-dev --to-revision=2
```

### 2. ìˆ˜ë™ ë°°í¬ ì œì–´
```bash
# ë°°í¬ ì§„í–‰ (ë‹¤ìŒ ë‹¨ê³„ë¡œ)
kubectl argo rollouts promote app-fe -n test-dev

# ë°°í¬ ì¤‘ë‹¨
kubectl argo rollouts pause app-fe -n test-dev

# ë°°í¬ ì¬ê°œ
kubectl argo rollouts resume app-fe -n test-dev

# ë°°í¬ ì¤‘ë‹¨
kubectl argo rollouts abort app-fe -n test-dev
```

### 3. ë¡œê·¸ ë° ì´ë²¤íŠ¸ í™•ì¸
```bash
# ë¡¤ì•„ì›ƒ ì´ë²¤íŠ¸ í™•ì¸
kubectl describe rollout app-fe -n test-dev

# íŒŒë“œ ë¡œê·¸ í™•ì¸
kubectl logs -l app=app-fe -n test-dev -f

# ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
kubectl get endpoints frontend-service -n test-dev
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. ì¼ë°˜ì ì¸ ë¬¸ì œë“¤

#### Connection Refused ì˜¤ë¥˜
**ì¦ìƒ**: ë°°í¬ ì¤‘ `ECONNREFUSED` ì˜¤ë¥˜ ë°œìƒ

**ì›ì¸**:
- `readinessProbe` ì„¤ì • ë¶€ì¡±
- í¬íŠ¸ ë¶ˆì¼ì¹˜ (íŠ¹íˆ Kong ì‚¬ìš© ì‹œ)
- ìƒˆ íŒŒë“œê°€ ì™„ì „íˆ ì¤€ë¹„ë˜ê¸° ì „ì— íŠ¸ë˜í”½ ì „í™˜

**í•´ê²° ë°©ë²•**:
```yaml
readinessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
```

#### 500 ì—ëŸ¬ (Blue-Green ë°°í¬ ì‹œ)
**ì¦ìƒ**: íŠ¸ë˜í”½ ì „í™˜ ì‹œ ì¼ì‹œì  500 ì—ëŸ¬

**ì›ì¸**: Blue-Green ë°°í¬ì˜ íŠ¹ì„±ìƒ ë¶ˆê°€í”¼í•œ í˜„ìƒ

**í•´ê²° ë°©ë²•**:
- í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì¬ì‹œë„ ë¡œì§ êµ¬í˜„
- ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì • ìµœì í™”
- ì¹´ë‚˜ë¦¬ ë°°í¬ë¡œ ì „í™˜ ê³ ë ¤

### 2. ëª¨ë‹ˆí„°ë§ ì§€í‘œ

#### ë°°í¬ ì„±ê³µë¥  ëª¨ë‹ˆí„°ë§
```bash
# ë°°í¬ ìƒíƒœ í™•ì¸
kubectl get rollout app-fe -n test-dev -o yaml | grep -A 10 "status:"

# íŒŒë“œ ìƒíƒœ í™•ì¸
kubectl get pods -l app=app-fe -n test-dev

# ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
kubectl get endpoints frontend-service -n test-dev
```

#### ì„±ëŠ¥ ì§€í‘œ
- ì‘ë‹µ ì‹œê°„ (Response Time)
- ì—ëŸ¬ìœ¨ (Error Rate)
- ì²˜ë¦¬ëŸ‰ (Throughput)
- ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥  (CPU, Memory)

### 3. ë¡¤ë°± ì „ëµ

#### ìë™ ë¡¤ë°± ì¡°ê±´ ì„¤ì •
```yaml
spec:
  strategy:
    canary:
      analysis:
        templates:
          - templateName: success-rate
        args:
          - name: service-name
            value: frontend-service
        startingStep: 2
        rules:
          - name: success-rate
            template: success-rate
            failureLimit: 3
```

#### ìˆ˜ë™ ë¡¤ë°± ì ˆì°¨
1. ë°°í¬ ìƒíƒœ í™•ì¸
2. ë¬¸ì œ ì›ì¸ ë¶„ì„
3. ë¡¤ë°± ëª…ë ¹ ì‹¤í–‰
4. ì„œë¹„ìŠ¤ ì •ìƒí™” í™•ì¸
